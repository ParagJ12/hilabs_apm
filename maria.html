<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>HiLabs — Maria (Regional Coverage)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root{
      --hi-blue:#2c6aef; --accent:#2c6aef; --panel-bg:#ffffff; --muted:#6b7280; --bg:#f6f8fb;
    }
    html,body{height:100%;margin:0;font-family:system-ui, -apple-system, "Segoe UI", Roboto, Arial;background:var(--bg);color:#0b1220}
    .container{max-width:1320px;margin:12px auto;padding:0 8px;} /* tightened margins */
    /* Header */
    .header{background:var(--hi-blue);color:#fff;border-radius:12px;padding:12px 14px;margin-bottom:12px;display:flex;align-items:center;justify-content:space-between;gap:12px;box-shadow:0 8px 24px rgba(44,106,239,0.12)}
    .header-left h4{margin:0;font-weight:700;font-size:18px}
    .header-sub{font-size:13px;opacity:.95;margin-top:6px}
    .kpi-row{display:flex;gap:10px;align-items:center}
    .kpi{background:var(--panel-bg);padding:10px 12px;border-radius:8px;min-width:150px;text-align:center;border-left:4px solid var(--accent);box-shadow:0 4px 12px rgba(2,6,23,0.04)}
    .kpi .title{font-size:12px;color:var(--muted);font-weight:600;margin-bottom:6px}
    .kpi .val{font-weight:700;font-size:18px;margin-top:4px;color:#0b1220}
    .kpi .small-muted{font-size:11px;color:var(--muted);margin-top:4px}
    /* panels */
    .panel{background:var(--panel-bg);border-radius:10px;padding:12px;border-left:4px solid var(--accent);box-shadow:0 6px 18px rgba(2,6,23,0.04);display:flex;flex-direction:column}
    .panel h6{margin:0 0 8px 0;font-weight:700;border-bottom:2px solid var(--accent);padding-bottom:8px;font-size:15px}
    .small-muted{color:var(--muted);font-size:13px}
    /* layout grid tweaks */
    .row-gap{row-gap:12px}
    /* map */
    #map{height:320px;border-radius:8px;border:1px solid #e7eefb;position:relative}
    .map-legend{position:absolute;right:12px;top:12px;background:rgba(255,255,255,0.98);padding:8px 10px;border-radius:8px;border-left:4px solid var(--accent);box-shadow:0 6px 18px rgba(2,6,23,0.06);font-size:13px;min-width:200px;z-index:1000}
    .legend-row{display:flex;gap:8px;align-items:center;margin-bottom:6px}
    .sw{width:14px;height:14px;border-radius:3px;display:inline-block}
    /* table + scroll */
    .scroll-table{max-height:300px;overflow:auto;padding-right:6px}
    .table thead th{background:var(--accent);color:#fff;position:sticky;top:0;z-index:1;font-weight:700}
    .btn-compact{padding:6px 10px;font-size:13px}
    /* chat / AI */
    .chat-box{max-height:160px;overflow:auto;padding:8px;border-radius:6px;background:#fff;border:1px solid #eef2ff}
    .chat-row{margin-bottom:8px}
    .chat-user{ text-align:right }
    .chat-assistant{ text-align:left }
    .chat-bubble{ display:inline-block; max-width:86%; padding:8px 10px; border-radius:8px; border:1px solid #eef2ff; background:#fff; font-size:13px }
    .insights-list{max-height:120px; overflow:auto; padding:6px; background:#fff; border:1px solid #eef2ff; border-radius:6px}
    /* modal */
    .modal-body pre{white-space:pre-wrap}
    /* equal-height panels per row */
    .row-equal > .col-lg-4 > .panel,
    .row-equal > .col-lg-5 > .panel,
    .row-equal > .col-lg-6 > .panel,
    .row-equal > .col-lg-7 > .panel,
    .row-equal > .col-lg-8 > .panel {
      height:100%;
    }
    /* remove extra bottom spacer (was previously a height div) */
    .no-spacer{margin-bottom:0;padding-bottom:0}
    /* clean spacing, responsive */
    @media (max-width:1199px){
      .container{max-width:1000px}
    }
    @media (max-width:991px){
      .kpi-row{overflow:auto;padding-bottom:6px}
      #map{height:260px}
      .panel h6{font-size:14px}
      .map-legend{right:8px;left:auto;top:8px;min-width:170px}
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="header-left">
        <h4>HiLabs | Risk & Rate Intelligence Platform</h4>
        <div class="header-sub">User: Maria Santos — Regional Network Manager (Mid-Atlantic)</div>
      </div>

      <div class="kpi-row" aria-hidden="false">
        <div class="kpi">
          <div class="title">Coverage Adequacy</div>
          <div class="val" id="kpi-adequacy">94%</div>
          <div class="small-muted">Target 95%</div>
        </div>
        <div class="kpi">
          <div class="title">Total Providers</div>
          <div class="val" id="kpi-providers">1,245</div>
          <div class="small-muted">In-region</div>
        </div>
        <div class="kpi">
          <div class="title">Potential Savings</div>
          <div class="val" id="kpi-savings">$3.4M</div>
          <div class="small-muted">Negotiation targets</div>
        </div>
      </div>
    </div>

    <!-- top controls + map -->
    <div class="row row-gap row-equal g-3">
      <div class="col-lg-8">
        <div class="panel">
          <div class="d-flex flex-wrap gap-2 align-items-end mb-2">
            <div style="min-width:140px">
              <label class="small-muted">Type</label>
              <select id="type-filter" class="form-select form-select-sm">
                <option>Health</option><option>Life</option><option>Auto</option>
              </select>
            </div>
            <div style="min-width:140px">
              <label class="small-muted">Coverage Level</label>
              <select id="coverage-filter" class="form-select form-select-sm">
                <option>Basic</option><option selected>Standard</option><option>Premium</option><option>Comprehensive</option>
              </select>
            </div>
            <div style="min-width:140px">
              <label class="small-muted">Date Range</label>
              <select id="date-range" class="form-select form-select-sm">
                <option>Last 30 days</option><option selected>Last Quarter</option><option>Last 12 months</option><option>Custom</option>
              </select>
            </div>

            <!-- AI quick controls (compact) -->
            <div style="min-width:170px">
              <label class="small-muted">AI Quick</label>
              <div class="d-flex gap-1">
                <button id="run-scan" class="btn btn-outline-success btn-compact" title="Run AI quick scan">AI Scan</button>
                <button id="refresh-insights" class="btn btn-outline-primary btn-compact" title="Refresh insights">Insights</button>
                <button id="export-insights" class="btn btn-outline-secondary btn-compact" title="Export insights">Export</button>
              </div>
            </div>

            <div class="ms-auto d-flex gap-2">
              <button id="refresh-btn" class="btn btn-primary btn-compact">Refresh</button>
              <button id="export-btn" class="btn btn-outline-secondary btn-compact">Export</button>
            </div>
          </div>

          <div class="d-flex gap-3 align-items-start">
            <div style="flex:1">
              <h6>Current Coverage Status — Mid-Atlantic</h6>
              <div class="row gx-3">
                <div class="col-md-4 col-6 mb-2">
                  <div class="small-muted">Total Active Providers</div>
                  <div style="font-weight:700;font-size:16px" id="active-providers">1,245</div>
                </div>
                <div class="col-md-4 col-6 mb-2">
                  <div class="small-muted">Average Member Access Distance</div>
                  <div style="font-weight:700;font-size:16px" id="avg-dist">12.5 miles</div>
                </div>
                <div class="col-md-4 col-6 mb-2">
                  <div class="small-muted">Counties Below Threshold</div>
                  <div style="font-weight:700;font-size:16px" id="below-counties">3</div>
                </div>
              </div>
              <div class="mt-1">
                <div class="small-muted">Utilization</div>
                <div style="font-weight:700;font-size:16px" id="util">89%</div>
              </div>
            </div>

            <div style="width:320px; min-width:220px;">
              <div class="small-muted mb-2">Compliance</div>
              <div class="d-flex gap-2">
                <div style="flex:1;background:#ecfdf5;border-radius:8px;padding:8px"><div style="font-weight:700;color:#059669">Green</div><div class="small-muted">Compliant</div></div>
                <div style="flex:1;background:#fffbeb;border-radius:8px;padding:8px"><div style="font-weight:700;color:#b45309">Yellow</div><div class="small-muted">At Risk</div></div>
                <div style="flex:1;background:#fff1f2;border-radius:8px;padding:8px"><div style="font-weight:700;color:#b91c1c">Red</div><div class="small-muted">Non-compliant</div></div>
              </div>
            </div>
          </div>

          <div style="margin-top:10px" class="small-muted">Tip: Use filters above to update KPIs and map. Click a county on the map to filter providers.</div>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="panel h-100">
          <h6>Regional Adequacy Map</h6>
          <div id="map" class="mb-0"></div>

          <!-- compact AI Assistant + predictor below the map (kept inside panel to avoid layout shift) -->
          <div style="margin-top:10px; display:flex; gap:8px; align-items:flex-start;">
            <div style="flex:1; min-width:180px;">
              <label class="small-muted">AI Assistant</label>
              <div class="chat-box" id="chat-box"></div>
              <div style="display:flex;gap:6px;margin-top:6px;">
                <input id="chat-input" class="form-control form-control-sm" placeholder="Ask: Which county is highest risk?" />
                <button id="chat-send" class="btn btn-sm btn-primary">Send</button>
              </div>
            </div>

            <div style="width:170px; min-width:150px;">
              <label class="small-muted">Predictor</label>
              <div style="display:flex;gap:6px;align-items:center;">
                <select id="pred-metric" class="form-select form-select-sm" style="width:100%;">
                  <option value="adequacy">Adequacy %</option>
                  <option value="providers">Providers</option>
                  <option value="savings">Potential Savings (M)</option>
                </select>
              </div>
              <div style="display:flex;gap:6px;margin-top:6px;">
                <input id="pred-months" type="number" min="6" max="36" value="12" class="form-control form-control-sm" style="width:70px" />
                <button id="pred-run" class="btn btn-sm btn-outline-primary">Run</button>
              </div>
              <div id="pred-summary" style="font-size:12px;color:var(--muted);margin-top:6px"></div>
            </div>
          </div>

          <!-- Insights feed -->
          <div style="margin-top:10px">
            <label class="small-muted">AI Domain Insights</label>
            <div class="insights-list" id="insights-feed" style="margin-top:6px"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- provider table + goals -->
    <div class="row row-gap g-3" style="align-items:start;">
      <div class="col-lg-7">
        <div class="panel">
          <h6>Provider Network Details</h6>
          <div class="d-flex gap-2 mb-2 align-items-center">
            <input id="provider-search" class="form-control form-control-sm" placeholder="Search provider or county" />
            <select id="specialty-filter" class="form-select form-select-sm" style="width:180px">
              <option>All specialties</option><option>Cardiology</option><option>Orthopedics</option><option>Primary Care</option><option>Radiology</option>
            </select>
            <button id="apply-filter" class="btn btn-outline-primary btn-compact">Apply</button>
            <div class="ms-auto small-muted">Click a row to open negotiation brief</div>
          </div>
          <div class="scroll-table">
            <table class="table table-sm mb-0">
              <thead><tr><th>Provider</th><th>Specialty</th><th>County</th><th>Avg Rate vs Market</th><th>Member Load</th><th>Risk</th></tr></thead>
              <tbody id="provider-tbody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="col-lg-5">
        <div class="panel">
          <h6>Goals & Compliance</h6>
          <div class="mb-3">
            <div class="small-muted">Adequacy Target</div>
            <div style="font-weight:700;font-size:18px">95% by Q4</div>
            <div class="progress mt-2 mb-2"><div class="progress-bar" id="goal-progress" role="progressbar" style="width:94%">94%</div></div>
          </div>

          <div class="mb-3">
            <div class="small-muted">Counties Needing Action</div>
            <ul id="action-list" style="margin-top:8px"></ul>
          </div>

          <h6 style="margin-top:6px">Cost Management</h6>
          <div class="d-flex gap-3">
            <div style="flex:1">
              <div class="small-muted">Regional Spend (Q3)</div><div style="font-weight:700" id="spend">$82.4M</div>
              <div class="small-muted mt-2">Rate Variance vs Market</div><div style="font-weight:700" id="rate-variance">+5.8%</div>
            </div>
            <div style="flex:1">
              <div class="small-muted">Potential Savings</div><div style="font-weight:700" id="pot-savings">$3.4M</div>
              <div class="small-muted mt-2">Claim Denial Rate</div><div style="font-weight:700" id="denial">7.3%</div>
            </div>
          </div>

          <div class="mt-3 d-flex gap-2">
            <button id="run-audit" class="btn btn-primary btn-compact">Run Adequacy Audit</button>
            <button id="download-report" class="btn btn-outline-secondary btn-compact">Download Gap Report</button>
          </div>
        </div>
      </div>
    </div>

    <!-- trend + quick actions -->
    <div class="row row-gap g-3" style="align-items:start;">
      <div class="col-lg-8">
        <div class="panel">
          <h6>Budget vs Actual & Rate Trends</h6>
          <div id="trend-plot" style="height:300px"></div>
        </div>
      </div>
      <div class="col-lg-4">
        <div class="panel">
          <h6>Quick Actions</h6>
          <div class="d-flex flex-column gap-2">
            <button class="btn btn-outline-primary">Create Recruitment Request</button>
            <button class="btn btn-outline-warning">Flag Provider for Re-contract</button>
            <button class="btn btn-outline-success">Push Telehealth Expansion</button>
          </div>
          <div class="mt-3 small-muted">Actions are mock/stubbed for the demo.</div>
        </div>
      </div>
    </div>

    <div class="small-muted text-center mb-2">Prototype (synthetic data) — HiLabs 2025 • No PHI • Last updated: Nov 2025</div>
  </div>

  <!-- modal for negotiation brief -->
  <div class="modal fade" id="briefModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="briefTitle">Negotiation Brief</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="briefBody">
          <pre id="briefPre"></pre>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- libs (added leaflet.heat for heatmap) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/plotly.js-dist@2.24.0/plotly.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.heat/0.2.0/leaflet-heat.js"></script>

  <script>
    // --- original synthetic county + provider data (kept) ---
    const counties = [
      {id:'Allegheny', lat:40.44, lon:-79.98, adequacy:87, pop:1250, suggest:"Add 2 PCPs"},
      {id:'Somerset', lat:40.02, lon:-79.08, adequacy:82, pop:45, suggest:"Recruit 1 Cardiologist"},
      {id:'Harford', lat:39.55, lon:-76.34, adequacy:92, pop:260, suggest:"Telehealth expansion"},
      {id:'Cambria', lat:40.49, lon:-78.77, adequacy:96, pop:130, suggest:"OK"},
      {id:'York', lat:39.96, lon:-76.73, adequacy:95, pop:450, suggest:"OK"},
      {id:'Lancaster', lat:40.04, lon:-76.30, adequacy:90, pop:400, suggest:"Monitor"}
    ];
    let providers = [
      {name:"Allegheny Cardio Clinic", spec:"Cardiology", county:"Allegheny", diff:12, load:420, risk:"High"},
      {name:"Somerset Ortho Center", spec:"Orthopedics", county:"Somerset", diff:9, load:120, risk:"Moderate"},
      {name:"Harford Primary Care", spec:"Primary Care", county:"Harford", diff:4, load:210, risk:"Low"},
      {name:"Cambria Radiology", spec:"Radiology", county:"Cambria", diff:2, load:95, risk:"Low"},
      {name:"York Family Practice", spec:"Primary Care", county:"York", diff:-1, load:320, risk:"Low"},
      {name:"Lancaster Surgical", spec:"General Surgery", county:"Lancaster", diff:7, load:150, risk:"Moderate"}
    ];

    const networkVariants = {
      "Health|Standard": {spend:82.4, leakage:3.4, pos:"+5.8%", providers:1245},
      "Health|Premium": {spend:95.2, leakage:5.1, pos:"+7.6%", providers:1480},
      "Health|Basic": {spend:64.3, leakage:2.1, pos:"+3.2%", providers:980},
      "Life|Comprehensive": {spend:50.1, leakage:1.1, pos:"+2.0%", providers:680},
      "Auto|Standard": {spend:28.6, leakage:0.6, pos:"+1.8%", providers:540}
    };

    // --- initialize map with heat overlay ---
    const map = L.map('map',{zoomControl:true, scrollWheelZoom:false}).setView([40.0,-78.0],7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OpenStreetMap'}).addTo(map);

    // legend inside map
    const legend = document.createElement('div');
    legend.className = 'map-legend';
    legend.innerHTML = `<div style="font-weight:700;margin-bottom:6px">Coverage Legend</div>
      <div class="legend-row"><span class="sw" style="background:#10b981"></span><div>Green: ≥95% (Compliant)</div></div>
      <div class="legend-row"><span class="sw" style="background:#f59e0b"></span><div>Yellow: 90–95% (At Risk)</div></div>
      <div class="legend-row"><span class="sw" style="background:#ef4444"></span><div>Red: &lt;90% (Non-compliant)</div></div>
      <div style="font-size:12px;color:var(--muted);margin-top:6px">Colors = adequacy %</div>`;
    document.getElementById('map').appendChild(legend);

    let markerLayer = L.layerGroup().addTo(map);
    let heatLayer = null;

    function buildHeatPoints(){
      // Use county adequacy inversely as intensity (lower adequacy -> hotter)
      const raw = counties.map(c => ({lat:c.lat, lng:c.lon, score: Math.max(0, 100 - c.adequacy) * (c.pop/100)}));
      const maxScore = Math.max(...raw.map(r=>r.score), 1);
      return raw.map(r => [r.lat, r.lng, Math.min(1, r.score / maxScore)]);
    }

    function drawCountiesHeat(){
      markerLayer.clearLayers();
      if(heatLayer){ map.removeLayer(heatLayer); heatLayer = null; }
      const heatPoints = buildHeatPoints();
      heatLayer = L.heatLayer(heatPoints, {radius: 30, blur: 25, maxZoom: 12, gradient:{0.2:'blue',0.5:'orange',0.9:'red'}}).addTo(map);

      counties.forEach(c=>{
        const color = c.adequacy >=95 ? '#10b981' : (c.adequacy >=90 ? '#f59e0b' : '#ef4444');
        const marker = L.circleMarker([c.lat,c.lon],{radius:9, fillColor:color, color:'#071227', weight:1, fillOpacity:0.95}).addTo(markerLayer);
        marker.bindTooltip(`<strong>${c.id}</strong><br>Adequacy: ${c.adequacy}%<br>Pop(k): ${c.pop}<br>Action: ${c.suggest}`);
        marker.on('click', ()=> {
          document.getElementById('provider-search').value = c.id;
          applyProviderFilter();
          appendChat('assistant', `Filtered to ${c.id} — suggestion: ${c.suggest}`);
        });
      });
      setTimeout(()=> map.invalidateSize(), 150);
    }
    drawCountiesHeat();

    // --- provider table rendering & brief modal (kept) ---
    function renderProviders(list){
      const tbody = document.getElementById('provider-tbody');
      tbody.innerHTML = '';
      list.forEach(p=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td style="font-weight:600;cursor:pointer">${p.name}</td><td>${p.spec}</td><td>${p.county}</td><td>${p.diff>0? '+'+p.diff+'%': p.diff+'%'}</td><td>${p.load}</td><td>${p.risk}</td>`;
        tr.addEventListener('click', ()=> openBrief(p));
        tbody.appendChild(tr);
      });
    }
    renderProviders(providers);

    const briefModal = new bootstrap.Modal(document.getElementById('briefModal'));
    function openBrief(p){
      document.getElementById('briefTitle').innerText = p.name + " — Negotiation Brief";
      const text = [
        `Provider: ${p.name}`,
        `Specialty: ${p.spec}`,
        `County: ${p.county}`,
        `Avg rate above market: ${p.diff}%`,
        `Member load: ${p.load}`,
        `Risk: ${p.risk}`,
        ``,
        `Recommendation: Consider targeted renegotiation. Suggested approach: staged reduction (start -4%), monitor acceptance. If provider exits, recruit replacement in county.`,
        ``,
        `Estimated regional impact: $${(p.diff*0.05).toFixed(2)}M`,
        `Model rationale: Overpayment driven by provider concentration (HHI 0.62) and historical rate trend.`
      ].join("\n");
      document.getElementById('briefPre').innerText = text;
      briefModal.show();
    }

    // --- filtering logic (kept) ---
    function applyProviderFilter(){
      const q = document.getElementById('provider-search').value.trim().toLowerCase();
      const spec = document.getElementById('specialty-filter').value;
      const filtered = providers.filter(p=>{
        const okQ = !q || p.name.toLowerCase().includes(q) || p.county.toLowerCase().includes(q);
        const okSpec = spec === 'All specialties' || p.spec === spec;
        return okQ && okSpec;
      });
      renderProviders(filtered);
    }
    document.getElementById('apply-filter').addEventListener('click', applyProviderFilter);
    document.getElementById('provider-search').addEventListener('keydown', e=>{ if(e.key==='Enter') applyProviderFilter(); });

    // --- trends (kept, slightly reduced height) ---
    function renderTrend(){
      const months=['Mar','Apr','May','Jun','Jul','Aug','Sep'];
      const budget=[12,11.5,11.8,12.2,12,11.9,12.5];
      const actual=[12.4,11.8,12.5,13.2,12.6,12.3,12.9];
      const rate=[4.2,4.6,5.0,5.1,5.4,5.6,5.8];
      const t1={x:months,y:budget,name:'Budget ($M)',type:'bar',marker:{color:'#cfe1ff'}};
      const t2={x:months,y:actual,name:'Actual ($M)',type:'bar',marker:{color:'#2c6aef'}};
      const t3={x:months,y:rate,name:'Rate Variance (%)',yaxis:'y2',mode:'lines+markers',marker:{color:'#f59e0b'},line:{width:3}};
      const layout={margin:{t:20,l:40,r:40,b:50},yaxis:{title:'$M'},yaxis2:{title:'Rate %',overlaying:'y',side:'right'},legend:{orientation:'h',y:-0.18}};
      Plotly.newPlot('trend-plot',[t1,t2,t3],layout,{displayModeBar:false,responsive:true});
    }
    renderTrend();

    // --- KPI refresh & UI wiring (kept & tightened) ---
    function updateKPIs(){
      const type = document.getElementById('type-filter').value;
      const coverage = document.getElementById('coverage-filter').value;
      const key = `${type}|${coverage}`;
      const v = networkVariants[key] || {spend:82.4, leakage:3.4, pos:"+5.8%", providers:1245};
      document.getElementById('spend').innerText = `$${v.spend}M`;
      document.getElementById('pot-savings').innerText = `$${v.leakage}M`;
      document.getElementById('rate-variance').innerText = v.pos;
      document.getElementById('kpi-providers').innerText = v.providers.toLocaleString();
      document.getElementById('kpi-savings').innerText = `$${v.leakage}M`;
      document.getElementById('active-providers').innerText = v.providers.toLocaleString();

      const baseAdequacy = Math.round(counties.reduce((s,c)=>s+c.adequacy,0)/counties.length);
      const adj = (coverage==='Premium'?1:coverage==='Basic'?-2:0);
      const adequacy = Math.max(78, Math.min(98, baseAdequacy + adj));
      document.getElementById('kpi-adequacy').innerText = adequacy + '%';
      document.getElementById('goal-progress').style.width = adequacy + '%';
      document.getElementById('goal-progress').innerText = adequacy + '%';

      document.getElementById('action-list').innerHTML = counties.filter(c=>c.adequacy<95).map(c=>`<li>${c.id} — ${c.suggest}</li>`).join('') || '<li>None</li>';
      document.getElementById('below-counties').innerText = counties.filter(c=>c.adequacy<90).length;
      document.getElementById('avg-dist').innerText = (12.5 + (coverage==='Premium'?-1:coverage==='Basic'?1.5:0)).toFixed(1) + " miles";
      document.getElementById('util').innerText = (89 + (coverage==='Premium'?1:-1)) + '%';
    }

    document.getElementById('refresh-btn').addEventListener('click', ()=>{
      counties.forEach(c=> c.adequacy = Math.max(78, Math.min(98, Math.round(c.adequacy + (Math.random()*5-2)))));
      drawCountiesHeat();
      updateKPIs();
      renderProviders(providers);
      renderTrend();
    });
    document.getElementById('export-btn').addEventListener('click', ()=> alert('Export stub — implement html2canvas or server export in production.'));
    document.getElementById('run-audit').addEventListener('click', ()=> alert('Adequacy audit triggered (demo).'));
    document.getElementById('download-report').addEventListener('click', ()=> alert('Download stub — gap report (demo).'));
    document.getElementById('type-filter').addEventListener('change', updateKPIs);
    document.getElementById('coverage-filter').addEventListener('change', updateKPIs);
    document.getElementById('date-range').addEventListener('change', updateKPIs);

    // --- AI features: Insights, Chat, Predictor, Quick Scan ---
    const insightsEl = document.getElementById('insights-feed');
    const syntheticInsights = [
      {title:'Coding audit finds upcoding signals', src:'HiLabs AI', time:'3h ago', summary:'Preliminary audit suggests coding variance in Allegheny leading to ~3% inflation.'},
      {title:'Telehealth increases access', src:'Domain Monitor', time:'7h ago', summary:'Expanding telehealth in rural counties reduced access gap by 9% in pilots.'},
      {title:'Specialty consolidation raises rates', src:'HealthNews', time:'1d ago', summary:'Ortho market concentration correlated with +8% price premium.'}
    ];
    function renderInsights(items=syntheticInsights){ insightsEl.innerHTML=''; items.forEach(it=>{ const d=document.createElement('div'); d.style.padding='8px 6px'; d.style.borderBottom='1px solid #f1f6ff'; d.innerHTML=`<div style="font-weight:700">${it.title}</div><div style="font-size:12px;color:var(--muted)">${it.src} • ${it.time}</div><div style="margin-top:6px">${it.summary}</div>`; insightsEl.appendChild(d); }); }
    renderInsights();

    // compact chat (rule-based with optional LLM hook)
    const chatBox = document.getElementById('chat-box');
    function appendChat(role, text){
      const row = document.createElement('div'); row.className='chat-row ' + (role==='user'?'chat-user':'chat-assistant');
      row.innerHTML = `<div class="chat-bubble">${text}</div>`; chatBox.appendChild(row); chatBox.scrollTop = chatBox.scrollHeight;
    }
    function simpleChatReply(q){
      const lq = q.toLowerCase();
      if(lq.includes('highest') && lq.includes('risk')) {
        // compute hottest county (by heat score)
        const top = counties.slice().sort((a,b)=> (100-a.adequacy)*(a.pop/100) - (100-b.adequacy)*(b.pop/100))[0];
        return `Highest risk county: ${top.id} — adequacy ${top.adequacy}%. Suggest: ${top.suggest}.`;
      }
      if(lq.includes('predict') || lq.includes('forecast')){
        return `Use the small Predictor control to generate a 3-month linear forecast of a chosen metric.`;
      }
      if(lq.includes('specialty') || lq.includes('which specialty')){
        return `Start with Primary Care or Cardiology depending on county — run targeted RFP in counties with adequacy < 92%.`;
      }
      return `I can answer: "Which county is highest risk", "Which specialty to target", or explain how to run a forecast. Try one of those.`;
    }
    document.getElementById('chat-send').addEventListener('click', ()=> {
      const q = document.getElementById('chat-input').value.trim(); if(!q) return; document.getElementById('chat-input').value='';
      appendChat('user', q); appendChat('assistant', 'Thinking...');
      setTimeout(()=> {
        const reply = simpleChatReply(q);
        chatBox.lastChild.innerHTML = `<div class="chat-bubble">${reply}</div>`;
      }, 300);
    });
    appendChat('assistant', 'Hi — HiLabs Assistant. Try: "Which county is highest risk?" or "Which specialty to target?"');

    // Predictor: tiny client-side linear reg for demonstration
    function linreg(xs, ys){
      const n = xs.length; const mx = xs.reduce((a,b)=>a+b,0)/n; const my = ys.reduce((a,b)=>a+b,0)/n;
      let num=0, den=0, ssTot=0, ssRes=0;
      for(let i=0;i<n;i++){ num+=(xs[i]-mx)*(ys[i]-my); den+=(xs[i]-mx)*(xs[i]-mx); }
      const slope = den===0?0:num/den; const intercept = my - slope*mx;
      for(let i=0;i<n;i++){ ssTot += (ys[i]-my)*(ys[i]-my); ssRes += (ys[i] - (slope*xs[i]+intercept))**2; }
      const r2 = ssTot===0?1:Math.max(0,1 - ssRes/ssTot);
      return {slope, intercept, r2};
    }

    function synthMetricHistory(metric, months){
      // small synthetic history per metric
      const base = { adequacy:92, providers:1245, savings:3.4 };
      const trend = { adequacy:-0.05, providers:2, savings:0.02 };
      const arr=[]; for(let i=months-1;i>=0;i--){ const noise=(Math.random()-0.5)*(metric==='adequacy'?0.8: metric==='providers'?6:0.2); arr.push(Number((base[metric] + trend[metric]*i + noise).toFixed(2))); } return arr;
    }

    document.getElementById('pred-run').addEventListener('click', ()=>{
      const metric = document.getElementById('pred-metric').value;
      const months = Number(document.getElementById('pred-months').value) || 12;
      const hist = synthMetricHistory(metric, months);
      const xs = Array.from({length:months}, (_,i)=>i);
      const model = linreg(xs, hist);
      const preds = [months, months+1, months+2].map(x=> Number((model.slope*x + model.intercept).toFixed(2)));
      document.getElementById('pred-summary').innerText = `Next 3-month: ${preds.join(', ')} (R² ${(model.r2*100).toFixed(0)}%)`;
    });

    // Quick AI scan: inject contextual insight & chat entry
    function runQuickScan(){
      // pick hottest county metric: low adequacy * pop
      const scored = counties.map(c=> ({...c, score: (100 - c.adequacy) * (c.pop/100)})).sort((a,b)=>b.score-a.score);
      const top = scored[0];
      const insight = { title: `QuickScan: ${top.id} flagged`, src:'HiLabs AI', time:'now', summary:`${top.id} has adequacy ${top.adequacy}%. Suggest: ${top.suggest}` };
      renderInsights([insight, ...syntheticInsights]);
      appendChat('assistant', `QuickScan complete: ${top.id} flagged. Insights panel updated.`);
    }
    document.getElementById('run-scan').addEventListener('click', runQuickScan);

    // Refresh insights button
    document.getElementById('refresh-insights').addEventListener('click', ()=> {
      renderInsights();
      appendChat('assistant', 'Insights refreshed.');
    });
    document.getElementById('export-insights').addEventListener('click', ()=> {
      const nodes = Array.from(document.querySelectorAll('#insights-feed > div'));
      const rows = nodes.map(n => {
        const title = n.children[0].innerText;
        const meta = n.children[1].innerText;
        const summary = n.children[2].innerText;
        return `"${title.replace(/"/g,'""')}","${meta.replace(/"/g,'""')}","${summary.replace(/"/g,'""')}"`;
      });
      const csv = 'title,meta,summary\n' + rows.join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'insights.csv'; a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    // small polishing: initial rendering & KPIs
    (function init(){ updateKPIs(); renderProviders(providers); renderTrend(); })();
  </script>
</body>
</html>
