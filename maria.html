<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>HiLabs â€” Maria (Regional Coverage)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root{
      --hi-blue:#2c6aef; --accent:#2c6aef; --panel-bg:#ffffff; --muted:#6b7280; --bg:#f6f8fb;
    }
    html,body{height:100%;margin:0;font-family:system-ui, -apple-system, "Segoe UI", Roboto, Arial;background:var(--bg);color:#0b1220}
    .container{max-width:1320px;margin:18px auto;padding:0 12px;}
    /* Header */
    .header{background:var(--hi-blue);color:#fff;border-radius:12px;padding:14px 18px;margin-bottom:18px;display:flex;align-items:center;justify-content:space-between;gap:12px;box-shadow:0 8px 24px rgba(44,106,239,0.12)}
    .header-left h4{margin:0;font-weight:700;font-size:20px}
    .header-sub{font-size:13px;opacity:.95;margin-top:6px}
    .kpi-row{display:flex;gap:12px;align-items:center}
    .kpi{background:var(--panel-bg);padding:12px 14px;border-radius:10px;min-width:160px;text-align:center;border-left:4px solid var(--accent);box-shadow:0 4px 12px rgba(2,6,23,0.04)}
    .kpi .title{font-size:12px;color:var(--muted);font-weight:600;margin-bottom:6px}
    .kpi .val{font-weight:700;font-size:20px;margin-top:4px;color:#0b1220}
    .kpi .small-muted{font-size:11px;color:var(--muted);margin-top:4px}
    /* panels */
    .panel{background:var(--panel-bg);border-radius:10px;padding:14px;border-left:4px solid var(--accent);box-shadow:0 6px 18px rgba(2,6,23,0.04);display:flex;flex-direction:column}
    .panel h6{margin:0 0 10px 0;font-weight:700;border-bottom:2px solid var(--accent);padding-bottom:8px;font-size:15px}
    .small-muted{color:var(--muted);font-size:13px}
    /* layout grid tweaks */
    .row-gap{row-gap:14px}
    /* map */
    #map{height:320px;border-radius:8px;border:1px solid #e7eefb;position:relative}
    .map-legend{position:absolute;right:12px;top:12px;background:rgba(255,255,255,0.98);padding:8px 10px;border-radius:8px;border-left:4px solid var(--accent);box-shadow:0 6px 18px rgba(2,6,23,0.06);font-size:13px;min-width:200px;z-index:1000}
    .legend-row{display:flex;gap:8px;align-items:center;margin-bottom:6px}
    .sw{width:14px;height:14px;border-radius:3px;display:inline-block}
    /* table + scroll */
    .scroll-table{max-height:300px;overflow:auto;padding-right:6px}
    .table thead th{background:var(--accent);color:#fff;position:sticky;top:0;z-index:1;font-weight:700}
    .btn-compact{padding:6px 10px;font-size:13px}
    /* modal */
    .modal-body pre{white-space:pre-wrap}
    /* equal-height panels per row */
    .row-equal > .col-lg-4 > .panel,
    .row-equal > .col-lg-5 > .panel,
    .row-equal > .col-lg-6 > .panel,
    .row-equal > .col-lg-7 > .panel,
    .row-equal > .col-lg-8 > .panel {
      height:100%;
    }
    /* clean spacing, responsive */
    @media (max-width:1199px){
      .container{max-width:1000px}
    }
    @media (max-width:991px){
      .kpi-row{overflow:auto;padding-bottom:6px}
      #map{height:260px}
      .panel h6{font-size:14px}
      .map-legend{right:8px;left:auto;top:8px;min-width:170px}
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="header-left">
        <h4>HiLabs | Risk & Rate Intelligence Platform</h4>
        <div class="header-sub">User: Maria Santos â€” Regional Network Manager (Mid-Atlantic)</div>
      </div>

      <div class="kpi-row" aria-hidden="false">
        <div class="kpi">
          <div class="title">Coverage Adequacy</div>
          <div class="val" id="kpi-adequacy">94%</div>
          <div class="small-muted">Target 95%</div>
        </div>
        <div class="kpi">
          <div class="title">Total Providers</div>
          <div class="val" id="kpi-providers">1,245</div>
          <div class="small-muted">In-region</div>
        </div>
        <div class="kpi">
          <div class="title">Potential Savings</div>
          <div class="val" id="kpi-savings">$3.4M</div>
          <div class="small-muted">Negotiation targets</div>
        </div>
      </div>
    </div>

    <!-- top controls + map -->
    <div class="row row-gap row-equal">
      <div class="col-lg-8">
        <div class="panel">
          <div class="d-flex flex-wrap gap-2 align-items-end mb-3">
            <div style="min-width:160px">
              <label class="small-muted">Type</label>
              <select id="type-filter" class="form-select form-select-sm">
                <option>Health</option><option>Life</option><option>Auto</option>
              </select>
            </div>
            <div style="min-width:160px">
              <label class="small-muted">Coverage Level</label>
              <select id="coverage-filter" class="form-select form-select-sm">
                <option>Basic</option><option selected>Standard</option><option>Premium</option><option>Comprehensive</option>
              </select>
            </div>
            <div style="min-width:160px">
              <label class="small-muted">Date Range</label>
              <select id="date-range" class="form-select form-select-sm">
                <option>Last 30 days</option><option selected>Last Quarter</option><option>Last 12 months</option><option>Custom</option>
              </select>
            </div>
            <div class="ms-auto d-flex gap-2">
              <button id="refresh-btn" class="btn btn-primary btn-compact">Refresh</button>
              <button id="export-btn" class="btn btn-outline-secondary btn-compact">Export</button>
            </div>
          </div>

          <div class="d-flex gap-3 align-items-start">
            <div style="flex:1">
              <h6>Current Coverage Status â€” Mid-Atlantic</h6>
              <div class="row gx-3">
                <div class="col-md-4 col-6 mb-2">
                  <div class="small-muted">Total Active Providers</div>
                  <div style="font-weight:700;font-size:16px" id="active-providers">1,245</div>
                </div>
                <div class="col-md-4 col-6 mb-2">
                  <div class="small-muted">Average Member Access Distance</div>
                  <div style="font-weight:700;font-size:16px" id="avg-dist">12.5 miles</div>
                </div>
                <div class="col-md-4 col-6 mb-2">
                  <div class="small-muted">Counties Below Threshold</div>
                  <div style="font-weight:700;font-size:16px" id="below-counties">3</div>
                </div>
              </div>
              <div class="mt-2">
                <div class="small-muted">Utilization</div>
                <div style="font-weight:700;font-size:16px" id="util">89%</div>
              </div>
            </div>

            <div style="width:320px; min-width:220px;">
              <div class="small-muted mb-2">Compliance</div>
              <div class="d-flex gap-2">
                <div style="flex:1;background:#ecfdf5;border-radius:8px;padding:10px"><div style="font-weight:700;color:#059669">Green</div><div class="small-muted">Compliant</div></div>
                <div style="flex:1;background:#fffbeb;border-radius:8px;padding:10px"><div style="font-weight:700;color:#b45309">Yellow</div><div class="small-muted">At Risk</div></div>
                <div style="flex:1;background:#fff1f2;border-radius:8px;padding:10px"><div style="font-weight:700;color:#b91c1c">Red</div><div class="small-muted">Non-compliant</div></div>
              </div>
            </div>
          </div>

          <div style="margin-top:12px" class="small-muted">Tip: Use filters above to update KPIs and map. Click a county on the map to filter providers.</div>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="panel h-100">
          <h6>Regional Adequacy Map</h6>
          <div id="map" class="mb-0"></div>
        </div>
      </div>
    </div>

    <!-- provider table + goals -->
    <div class="row row-gap" style="align-items:start;">
      <div class="col-lg-7">
        <div class="panel">
          <h6>Provider Network Details</h6>
          <div class="d-flex gap-2 mb-2 align-items-center">
            <input id="provider-search" class="form-control form-control-sm" placeholder="Search provider or county" />
            <select id="specialty-filter" class="form-select form-select-sm" style="width:180px">
              <option>All specialties</option><option>Cardiology</option><option>Orthopedics</option><option>Primary Care</option><option>Radiology</option>
            </select>
            <button id="apply-filter" class="btn btn-outline-primary btn-compact">Apply</button>
            <div class="ms-auto small-muted">Click a row to open negotiation brief</div>
          </div>
          <div class="scroll-table">
            <table class="table table-sm mb-0">
              <thead><tr><th>Provider</th><th>Specialty</th><th>County</th><th>Avg Rate vs Market</th><th>Member Load</th><th>Risk</th></tr></thead>
              <tbody id="provider-tbody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="col-lg-5">
        <div class="panel">
          <h6>Goals & Compliance</h6>
          <div class="mb-3">
            <div class="small-muted">Adequacy Target</div>
            <div style="font-weight:700;font-size:18px">95% by Q4</div>
            <div class="progress mt-2 mb-2"><div class="progress-bar" id="goal-progress" role="progressbar" style="width:94%">94%</div></div>
          </div>

          <div class="mb-3">
            <div class="small-muted">Counties Needing Action</div>
            <ul id="action-list" style="margin-top:8px"></ul>
          </div>

          <h6 style="margin-top:6px">Cost Management</h6>
          <div class="d-flex gap-3">
            <div style="flex:1">
              <div class="small-muted">Regional Spend (Q3)</div><div style="font-weight:700" id="spend">$82.4M</div>
              <div class="small-muted mt-2">Rate Variance vs Market</div><div style="font-weight:700" id="rate-variance">+5.8%</div>
            </div>
            <div style="flex:1">
              <div class="small-muted">Potential Savings</div><div style="font-weight:700" id="pot-savings">$3.4M</div>
              <div class="small-muted mt-2">Claim Denial Rate</div><div style="font-weight:700" id="denial">7.3%</div>
            </div>
          </div>

          <div class="mt-3 d-flex gap-2">
            <button id="run-audit" class="btn btn-primary btn-compact">Run Adequacy Audit</button>
            <button id="download-report" class="btn btn-outline-secondary btn-compact">Download Gap Report</button>
          </div>
        </div>
      </div>
    </div>

    <!-- trend + quick actions -->
    <div class="row row-gap" style="align-items:start;">
      <div class="col-lg-8">
        <div class="panel">
          <h6>Budget vs Actual & Rate Trends</h6>
          <div id="trend-plot" style="height:320px"></div>
        </div>
      </div>
      <div class="col-lg-4">
        <div class="panel">
          <h6>Quick Actions</h6>
          <div class="d-flex flex-column gap-2">
            <button class="btn btn-outline-primary">Create Recruitment Request</button>
            <button class="btn btn-outline-warning">Flag Provider for Re-contract</button>
            <button class="btn btn-outline-success">Push Telehealth Expansion</button>
          </div>
          <div class="mt-3 small-muted">Actions are mock/stubbed for the demo.</div>
        </div>
      </div>
    </div>


    <!-- AI Features Section -->
    <div class="row row-gap" style="align-items:start;">
      <div class="col-lg-6">
        <div class="panel">
          <h6>ðŸ¤– AI Risk Scoring</h6>
          <div class="mb-3">
            <div class="small-muted">Automated Provider Risk Assessment</div>
            <div style="font-size:14px; margin-top:8px; line-height:1.6;">
              <div style="background:#f0f9ff; padding:10px; border-radius:6px; margin-bottom:8px;">
                <strong>High Risk:</strong> Allegheny Cardio (Concentration + 12% overcharge)<br/>
                <strong>Medium Risk:</strong> Somerset Ortho (Potential exit risk)<br/>
                <strong>Monitor:</strong> Lancaster Surgical (Trending +3% YoY)
              </div>
            </div>
            <button id="ai-risk-details" class="btn btn-outline-primary btn-compact mt-2">View ML Model Details</button>
          </div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="panel">
          <h6>âš¡ Anomaly Alerts</h6>
          <div class="mb-3">
            <div class="small-muted">Real-time Outlier Detection</div>
            <div style="font-size:14px; margin-top:8px; line-height:1.6;">
              <div style="background:#fef2f2; padding:10px; border-radius:6px; margin-bottom:8px;">
                ðŸ”´ <strong>Critical:</strong> Harford claim denial rate spike (+2.3% vs baseline)<br/>
                ðŸŸ¡ <strong>Warning:</strong> York member access time increased to 14.2 miles<br/>
                ðŸŸ¢ <strong>Info:</strong> Cambria utilization improved to 96%
              </div>
            </div>
            <button id="ai-anomaly-config" class="btn btn-outline-primary btn-compact mt-2">Configure Thresholds</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Predictive Insights & Recommendations -->
    <div class="row row-gap" style="align-items:start;">
      <div class="col-lg-8">
        <div class="panel">
          <h6>ðŸ”® Predictive Insights & Recommendations</h6>
          <div style="font-size:13px; line-height:1.8;">
            <div style="background:#f9fafb; padding:12px; border-radius:6px; margin-bottom:12px;">
              <strong>Next 90 Days Forecast:</strong><br/>
              â€¢ Predicted provider exits: 2â€“3 providers (Somerset, Lancaster)

              â€¢ Projected spend increase: +$2.1M (seasonal+rate trend)

              â€¢ Estimated adequacy drop: âˆ’2.4% if no action
/
            </div>
            <div style="background:#fffbeb; padding:12px; border-radius:6px; margin-bottom:12px;">
              <strong>ðŸŽ¯ Recommended Actions (Priority Order):</strong><br/>
              1. <strong>Proactive Recruitment:</strong> Somerset Cardiologist (prevent exit risk, +2 months lead time)

              2. <strong>Contract Renegotiation:</strong> Allegheny Cardio (staged âˆ’4% reduction, staged over 2Q)

              3. <strong>Telehealth Expansion:</strong> Harford (reduces access distance, addresses denial spike)

            </div>
          </div>
          <button id="ai-run-forecast" class="btn btn-primary btn-compact">Run Full Forecast Model</button>
          <button id="ai-export-insights" class="btn btn-outline-secondary btn-compact">Export AI Report</button>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="panel">
          <h6>ðŸ“Š Model Performance</h6>
          <div style="font-size:13px; margin-top:12px;">
            <div style="margin-bottom:12px;">
              <div class="small-muted">Risk Score Accuracy</div>
              <div style="font-weight:700; font-size:18px;">89.2%</div>
              <div class="progress mt-2 mb-2"><div class="progress-bar" role="progressbar" style="width:89.2%"></div></div>
            </div>
            <div style="margin-bottom:12px;">
              <div class="small-muted">Anomaly Precision</div>
              <div style="font-weight:700; font-size:18px;">92.5%</div>
              <div class="progress mt-2 mb-2"><div class="progress-bar bg-success" role="progressbar" style="width:92.5%"></div></div>
            </div>
            <div style="margin-bottom:12px;">
              <div class="small-muted">Forecast Confidence</div>
              <div style="font-weight:700; font-size:18px;">84.7%</div>
              <div class="progress mt-2 mb-2"><div class="progress-bar bg-warning" role="progressbar" style="width:84.7%"></div></div>
            </div>
          </div>
          <button id="ai-model-info" class="btn btn-outline-secondary btn-compact btn-sm mt-3" style="width:100%;">Model Info</button>
        </div>
      </div>
    </div>

    <div style="height:12px"></div>
    <div class="small-muted text-center mb-4">Prototype (synthetic data) â€” HiLabs 2025 â€¢ No PHI â€¢ Last updated: Nov 2025</div>
  </div>

  <!-- modal for negotiation brief -->
  <div class="modal fade" id="briefModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="briefTitle">Negotiation Brief</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="briefBody">
          <pre id="briefPre"></pre>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/plotly.js-dist@2.24.0/plotly.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // synthetic county + provider data
    const counties = [
      {id:'Allegheny', lat:40.44, lon:-79.98, adequacy:87, pop:1250, suggest:"Add 2 PCPs"},
      {id:'Somerset', lat:40.02, lon:-79.08, adequacy:82, pop:45, suggest:"Recruit 1 Cardiologist"},
      {id:'Harford', lat:39.55, lon:-76.34, adequacy:92, pop:260, suggest:"Telehealth expansion"},
      {id:'Cambria', lat:40.49, lon:-78.77, adequacy:96, pop:130, suggest:"OK"},
      {id:'York', lat:39.96, lon:-76.73, adequacy:95, pop:450, suggest:"OK"},
      {id:'Lancaster', lat:40.04, lon:-76.30, adequacy:90, pop:400, suggest:"Monitor"}
    ];
    let providers = [
      {name:"Allegheny Cardio Clinic", spec:"Cardiology", county:"Allegheny", diff:12, load:420, risk:"High"},
      {name:"Somerset Ortho Center", spec:"Orthopedics", county:"Somerset", diff:9, load:120, risk:"Moderate"},
      {name:"Harford Primary Care", spec:"Primary Care", county:"Harford", diff:4, load:210, risk:"Low"},
      {name:"Cambria Radiology", spec:"Radiology", county:"Cambria", diff:2, load:95, risk:"Low"},
      {name:"York Family Practice", spec:"Primary Care", county:"York", diff:-1, load:320, risk:"Low"},
      {name:"Lancaster Surgical", spec:"General Surgery", county:"Lancaster", diff:7, load:150, risk:"Moderate"}
    ];

    // network metric presets (used when Type / Coverage change)
    const networkVariants = {
      "Health|Standard": {spend:82.4, leakage:3.4, pos:"+5.8%", providers:1245},
      "Health|Premium": {spend:95.2, leakage:5.1, pos:"+7.6%", providers:1480},
      "Health|Basic": {spend:64.3, leakage:2.1, pos:"+3.2%", providers:980},
      "Life|Comprehensive": {spend:50.1, leakage:1.1, pos:"+2.0%", providers:680},
      "Auto|Standard": {spend:28.6, leakage:0.6, pos:"+1.8%", providers:540}
    };

    // initialize map
    const map = L.map('map',{zoomControl:true, scrollWheelZoom:false}).setView([40.0,-78.0],7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'Â© OpenStreetMap'}).addTo(map);

    // add legend into map container (leaflet controls would be alternative)
    const legend = document.createElement('div');
    legend.className = 'map-legend';
    legend.innerHTML = `<div style="font-weight:700;margin-bottom:6px">Coverage Legend</div>
      <div class="legend-row"><span class="sw" style="background:#10b981"></span><div>Green: â‰¥95% (Compliant)</div></div>
      <div class="legend-row"><span class="sw" style="background:#f59e0b"></span><div>Yellow: 90â€“95% (At Risk)</div></div>
      <div class="legend-row"><span class="sw" style="background:#ef4444"></span><div>Red: &lt;90% (Non-compliant)</div></div>
      <div style="font-size:12px;color:var(--muted);margin-top:6px">Colors = % above/below market median / adequacy</div>`;
    document.getElementById('map').appendChild(legend);

    let markers = [];
    function drawCounties(){
      markers.forEach(m => map.removeLayer(m));
      markers = [];
      counties.forEach(c=>{
        const color = c.adequacy >=95 ? '#10b981' : (c.adequacy >=90 ? '#f59e0b' : '#ef4444');
        const marker = L.circleMarker([c.lat,c.lon],{radius:11, fillColor:color, color:'#071227', weight:1.2, fillOpacity:0.95}).addTo(map);
        marker.bindTooltip(`<strong>${c.id}</strong><br>Adequacy: ${c.adequacy}%<br>Pop(k): ${c.pop}<br>Action: ${c.suggest}`);
        marker.on('click', ()=> {
          document.getElementById('provider-search').value = c.id;
          applyProviderFilter();
          document.getElementById('provider-tbody').scrollIntoView({behavior:'smooth'});
        });
        markers.push(marker);
      });
      // ensure map redraws properly after DOM changes
      setTimeout(()=> map.invalidateSize(), 200);
    }
    drawCounties();

    // populate provider table
    function renderProviders(list){
      const tbody = document.getElementById('provider-tbody');
      tbody.innerHTML = '';
      list.forEach(p=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td style="font-weight:600;cursor:pointer">${p.name}</td><td>${p.spec}</td><td>${p.county}</td><td>${p.diff>0? '+'+p.diff+'%': p.diff+'%'}</td><td>${p.load}</td><td>${p.risk}</td>`;
        tr.addEventListener('click', ()=> openBrief(p));
        tbody.appendChild(tr);
      });
    }
    renderProviders(providers);

    // basic trend plot
    function renderTrend(){
      const months=['Mar','Apr','May','Jun','Jul','Aug','Sep'];
      const budget=[12,11.5,11.8,12.2,12,11.9,12.5];
      const actual=[12.4,11.8,12.5,13.2,12.6,12.3,12.9];
      const rate=[4.2,4.6,5.0,5.1,5.4,5.6,5.8];
      const t1={x:months,y:budget,name:'Budget ($M)',type:'bar',marker:{color:'#cfe1ff'}};
      const t2={x:months,y:actual,name:'Actual ($M)',type:'bar',marker:{color:'#2c6aef'}};
      const t3={x:months,y:rate,name:'Rate Variance (%)',yaxis:'y2',mode:'lines+markers',marker:{color:'#f59e0b'},line:{width:3}};
      const layout={margin:{t:20,l:40,r:40,b:50},yaxis:{title:'$M'},yaxis2:{title:'Rate %',overlaying:'y',side:'right'},legend:{orientation:'h',y:-0.18}};
      Plotly.newPlot('trend-plot',[t1,t2,t3],layout,{displayModeBar:false,responsive:true});
    }
    renderTrend();

    // negotiation brief modal
    const briefModal = new bootstrap.Modal(document.getElementById('briefModal'));
    function openBrief(p){
      document.getElementById('briefTitle').innerText = p.name + " â€” Negotiation Brief";
      const text = [
        `Provider: ${p.name}`,
        `Specialty: ${p.spec}`,
        `County: ${p.county}`,
        `Avg rate above market: ${p.diff}%`,
        `Member load: ${p.load}`,
        `Risk: ${p.risk}`,
        ``,
        `Recommendation: Consider targeted renegotiation. Suggested approach: staged reduction (start -4%), monitor acceptance. If provider exits, recruit replacement in county.`,
        ``,
        `Estimated regional impact: $${(p.diff*0.05).toFixed(2)}M`,
        `Model rationale: Overpayment driven by provider concentration (HHI 0.62) and historical rate trend (+12% YoY).`
      ].join("\n");
      document.getElementById('briefPre').innerText = text;
      briefModal.show();
    }

    // filtering logic
    function applyProviderFilter(){
      const q = document.getElementById('provider-search').value.trim().toLowerCase();
      const spec = document.getElementById('specialty-filter').value;
      const filtered = providers.filter(p=>{
        const okQ = !q || p.name.toLowerCase().includes(q) || p.county.toLowerCase().includes(q);
        const okSpec = spec === 'All specialties' || p.spec === spec;
        return okQ && okSpec;
      });
      renderProviders(filtered);
    }
    document.getElementById('apply-filter').addEventListener('click', applyProviderFilter);
    document.getElementById('provider-search').addEventListener('keydown', e=>{ if(e.key==='Enter') applyProviderFilter(); });

    // KPI refresh logic tied to filters
    function updateKPIs(){
      const type = document.getElementById('type-filter').value;
      const coverage = document.getElementById('coverage-filter').value;
      const key = `${type}|${coverage}`;
      const v = networkVariants[key] || {spend:82.4, leakage:3.4, pos:"+5.8%", providers:1245};
      document.getElementById('spend').innerText = `$${v.spend}M`;
      document.getElementById('pot-savings').innerText = `$${v.leakage}M`;
      document.getElementById('rate-variance').innerText = v.pos;
      document.getElementById('kpi-providers').innerText = v.providers.toLocaleString();
      document.getElementById('kpi-savings').innerText = `$${v.leakage}M`;
      document.getElementById('active-providers').innerText = v.providers.toLocaleString();

      // adequacy change heuristic: better coverage -> +1 or -1
      const baseAdequacy = Math.round(counties.reduce((s,c)=>s+c.adequacy,0)/counties.length);
      const adj = (coverage==='Premium'?1:coverage==='Basic'?-2:0);
      const adequacy = Math.max(78, Math.min(98, baseAdequacy + adj));
      document.getElementById('kpi-adequacy').innerText = adequacy + '%';
      document.getElementById('goal-progress').style.width = adequacy + '%';
      document.getElementById('goal-progress').innerText = adequacy + '%';

      // update actions list
      const actions = counties.filter(c=>c.adequacy<95).map(c=>`<li>${c.id} â€” ${c.suggest}</li>`).join('');
      document.getElementById('action-list').innerHTML = actions || '<li>None</li>';

      // update small numbers
      document.getElementById('below-counties').innerText = counties.filter(c=>c.adequacy<90).length;
      document.getElementById('avg-dist').innerText = (12.5 + (coverage==='Premium'?-1:coverage==='Basic'?1.5:0)).toFixed(1) + " miles";
      document.getElementById('util').innerText = (89 + (coverage==='Premium'?1:-1)) + '%';
    }

    // refresh button: randomize slightly to demonstrate interactive updates
    document.getElementById('refresh-btn').addEventListener('click', ()=>{
      counties.forEach(c=> c.adequacy = Math.max(78, Math.min(98, Math.round(c.adequacy + (Math.random()*5-2)))));
      drawCounties();
      updateKPIs();
      renderProviders(providers);
      renderTrend();
    });

    // export stub
    document.getElementById('export-btn').addEventListener('click', ()=> alert('Export stub â€” implement html2canvas or server export in production.'));

    // audit + report stubs
    document.getElementById('run-audit').addEventListener('click', ()=> alert('Adequacy audit triggered (demo).'));
    document.getElementById('download-report').addEventListener('click', ()=> alert('Download stub â€” gap report (demo).'));

    // update filter handlers
    document.getElementById('type-filter').addEventListener('change', updateKPIs);
    document.getElementById('coverage-filter').addEventListener('change', updateKPIs);
    document.getElementById('date-range').addEventListener('change', updateKPIs);

    // initial render
    (function init(){
      updateKPIs();
      renderProviders(providers);
    })();
  
    // AI Features Event Handlers
    document.getElementById('ai-risk-details').addEventListener('click', ()=> {
      const modal_text = `AI Risk Scoring Model\n\nMethod: Ensemble (Gradient Boosting + Isolation Forest)\nFeatures: rate_variance, concentration_hhi, member_load, denial_trend, exit_probability\n\nTop Risk Drivers (Allegheny Cardio):\n1. Rate Variance: +12% (contributes 40% to risk score)\n2. HHI Concentration: 0.62 (mid-high, contributes 30%)\n3. Member Load: 420 (high, contributes 20%)\n4. Denial Trend: stable (low risk, contributes 10%)\n\nModel trained on 18-month historical data. Retrains weekly.\nAccuracy on validation set: 89.2%`;
      alert(modal_text);
    });

    document.getElementById('ai-anomaly-config').addEventListener('click', ()=> {
      const config = `Anomaly Detection Settings\n\nMethod: Isolation Forest + Z-score hybrid\nSensitivity: Medium (threshold: 2.5 sigma)\n\nMonitored Metrics:\n- Claim denial rate (baseline: 7.1%, alert: Â±2.5%)\n- Provider member load (rolling avg, alert: Â±30%)\n- Access distance (baseline: 12.5 miles, alert: >14 miles)\n- Rate variance (baseline: +5.8%, alert: >8% or <2%)\n\nUpdate frequency: Daily (00:00 UTC)\nRetention: 24 months rolling`;
      alert(config);
    });

    document.getElementById('ai-run-forecast').addEventListener('click', ()=> {
      alert('Running 90-day forecast model...\n\nScenarios:\n1. Base case (no action): adequacyâ†’91.6%, spend +$2.1M\n2. Proactive recruitment: adequacyâ†’93.2%, spend +$1.8M\n3. Full intervention (recruitment + renegotiation): adequacyâ†’95.1%, spend +$0.3M\n\nRecommended: Scenario 3 (ROI: 8.2x over 12 months)');
    });

    document.getElementById('ai-export-insights').addEventListener('click', ()=> {
      alert('Exporting AI insights report (PDF)...\nIncludes: Risk scores, anomalies, forecast scenarios, recommendations, model diagnostics.');
    });

    document.getElementById('ai-model-info').addEventListener('click', ()=> {
      const info = `Model Information\n\nName: HiLabs Risk & Adequacy Predictor v2.1\nLast Updated: 2025-11-08 03:45 UTC\nTraining Data: 18 months (500+ providers, 42 regions)\n\nComponent Models:\n- Risk Classifier: XGBoost (leaf_size=7, depth=6)\n- Anomaly Detector: Isolation Forest (contamination=0.08)\n- Demand Forecaster: LSTM + Prophet ensemble\n\nPerformance:\n- Risk AUC: 0.912 | F1: 0.88\n- Anomaly Precision: 92.5% | Recall: 87.1%\n- Forecast MAE: 3.2% on hold-out test set\n\nNext retraining: 2025-11-15`;
      alert(info);
    });
  
  </script>
