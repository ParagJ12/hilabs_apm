<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>HiLabs — HiView Dashboard (Jenifer Hayes)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root{
      --hi-blue:#2c6aef;
      --hi-bg:#f8f9fa;
      --panel-bg:#ffffff;
      --muted:#6b7280;
      --accent:#2c6aef;
    }
    html,body { height:100%; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; background:var(--hi-bg); margin:0; padding:0; color:#0b1220; }
    .container-fluid { padding:18px; max-width:1400px; margin:auto; }

    /* Header */
    .header {
      padding: 14px 18px; background: var(--hi-blue); color: #fff; border-radius:10px; margin-bottom: 14px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      box-shadow:0 6px 18px rgba(44,106,239,0.12);
      position:relative; z-index:1000;
    }
    .header-left { display:flex; flex-direction:column; }
    .header h4{ margin:0; font-weight:700; font-size:20px; }
    .header-subtitle{ font-size:13px; color: rgba(255,255,255,0.95); margin-top:6px; }
    .kpi-group { display:flex; gap:10px; align-items:center; flex-wrap:nowrap; overflow-x:auto; padding-left:6px; }
    .kpi { background:var(--panel-bg); border-radius:8px; padding:10px 12px; min-width:150px; text-align:center; box-shadow:0 2px 6px rgba(2,6,23,0.06); border-left:4px solid var(--accent); flex:0 0 auto; }
    .tile-title { font-size:12px; color:var(--muted); font-weight:600; }
    .tile-value { font-weight:700; font-size:18px; margin-top:4px; color:#0b1220; }

    /* Panels */
    .panel { background:var(--panel-bg); padding:14px; border-radius:10px; box-shadow:0 4px 10px rgba(2,6,23,0.04); border-left:4px solid var(--accent); }
    .panel h6 { margin-top:0; font-weight:700; font-size:16px; border-bottom:2px solid var(--accent); padding-bottom:8px; margin-bottom:12px; }
    .small-muted{ color:var(--muted); font-size:13px; }

    /* Map container - position relative to contain absolute legend */
    .map-container {
      position: relative;
      height: 360px;
      border-radius: 8px;
      overflow: hidden;
    }

    #map {
      height: 100%;
      width: 100%;
      border-radius: 8px;
      border: 1px solid #e6edf8;
      position: relative;
      z-index: 1;
    }

    /* Legend positioned INSIDE and ON TOP of map */
    .map-legend {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: rgba(255,255,255,0.98);
      padding: 10px 12px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      border-left: 3px solid var(--accent);
      font-size: 12px;
      min-width: 200px;
      backdrop-filter: blur(4px);
    }

    .legend-title { font-weight:700; margin-bottom:8px; font-size:13px; color:#0b1220; }
    .legend-row { display:flex; align-items:center; gap:8px; margin-bottom:6px; }
    .legend-swatch { width:16px; height:16px; border-radius:3px; display:inline-block; border:1px solid rgba(0,0,0,0.2); flex-shrink:0; }
    .legend-text { font-size:12px; color:#0b1220; }
    .legend-note { font-size:11px; color:var(--muted); margin-top:6px; line-height:1.3; }

    /* layout control */
    .panel-eq { min-height: 280px; display:flex; flex-direction:column; }

    /* tables */
    .scroll-table { max-height:210px; overflow:auto; padding-right:6px; }
    .table thead th { background:var(--accent); color:#fff; position:sticky; top:0; z-index:2; font-weight:700; font-size:12px; }
    .table-sm td { font-size:13px; color:#081827; }

    /* quality plot */
    #quality-plot { height:260px; width:100%; }

    /* scenario */
    .scenario-box { border-left:4px solid var(--accent); padding:16px; border-radius:10px; }
    .scenario-controls { min-width:260px; }
    .scenario-results { flex:1; max-height:240px; overflow:auto; padding-left:12px; }

    /* Market Intelligence / AI chat area */
    .chat-box { max-height:220px; overflow:auto; padding:8px; border-radius:8px; background:#fff; border:1px solid #eef2ff; }
    .chat-row { margin-bottom:8px; }
    .chat-user { text-align:right; }
    .chat-assistant { text-align:left; }
    .chat-bubble { display:inline-block; max-width:100%; padding:8px 10px; border-radius:8px; border:1px solid #eef2ff; background:#ffffff; }
    .ai-controls { margin-top:8px; display:flex; gap:8px; }

    /* footer */
    .footer{ text-align:center; color:var(--muted); margin-top:14px; font-size:13px; }

    /* responsive tweaks */
    @media (max-width: 1100px){
      .header{ flex-direction:column; align-items:flex-start; gap:12px; }
      .kpi { min-width:120px; padding:8px; }
      .map-container { height:300px; }
      #quality-plot { height:220px; }
      .panel-eq { min-height:220px; }
      .map-legend { right:8px; top:8px; min-width:170px; font-size:11px; }
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <!-- header -->
    <div class="header">
      <div class="header-left">
        <h4>HiLabs | Risk & Rate Intelligence Platform</h4>
        <div class="header-subtitle">User: Jenifer Hayes — VP, Network Strategy</div>
      </div>

      <div class="kpi-group" aria-hidden="false">
        <div class="kpi"><div class="tile-title">Patient Satisfaction</div><div class="tile-value">81 / 100</div><div class="small-muted">Conf 82%</div></div>
        <div class="kpi"><div class="tile-title">Provider ROI</div><div class="tile-value">112.6%</div><div class="small-muted">Conf 88%</div></div>
        <div class="kpi"><div class="tile-title">Accessibility</div><div class="tile-value">58 / 100</div><div class="small-muted">Conf 75%</div></div>
        <div class="kpi"><div class="tile-title">Value / Cost</div><div class="tile-value">132.3%</div><div class="small-muted">Conf 86%</div></div>
      </div>
    </div>

    <!-- top row -->
    <div class="row g-3 align-items-start">
      <div class="col-lg-3">
        <div class="panel panel-eq">
          <h6>Network Snapshot</h6>
          <label class="small-muted" style="font-weight:700">Network Name</label>
          <select id="network-name" class="form-select form-select-sm mb-2">
            <option value="PacificCare Integrated Health">PacificCare Integrated Health Network</option>
            <option value="Midwest Regional Medical">Midwest Regional Medical Alliance</option>
            <option value="Tri-State Wellness">Tri-State Wellness Group</option>
            <option value="Northeast Community Health">Northeast Community Health Partners</option>
            <option value="Southern Cross Healthcare">Southern Cross Healthcare Network</option>
            <option value="Great Plains Care Connect">Great Plains Care Connect</option>
            <option value="Bayview Specialty Health" selected>Bayview Specialty Health System</option>
            <option value="Rocky Mountain Health">Rocky Mountain Health Collaborative</option>
          </select>

          <label class="small-muted" style="font-weight:700">Network Type</label>
          <select id="network-type" class="form-select form-select-sm mb-2">
            <option>Type-1: Primary Care Network</option>
            <option>Type-2: Specialty Care Network</option>
            <option selected>Type-3: Behavioral Health Network</option>
            <option>Type-4: Dental/Vision Network</option>
            <option>Type-5: Multi-Specialty Network</option>
            <option>Type-6: Accountable Care Organization (ACO)</option>
            <option>Type-7: Managed Care Network (HMO/PPO)</option>
          </select>

          <label class="small-muted" style="font-weight:700">Coverage Area</label>
          <select id="coverage-area" class="form-select form-select-sm mb-3">
            <option value="Southwest">Southwest Corridor – AZ, NM, NV</option>
            <option value="New England">New England Region – MA, CT, RI, NH</option>
            <option value="Pacific Northwest">Pacific Northwest – WA, OR, Northern CA</option>
            <option value="Great Lakes" selected>Great Lakes Region – IL, MI, OH</option>
            <option value="Southeast">Southeast Coastal – FL, GA, SC</option>
            <option value="Mountain States">Mountain States – CO, UT, ID</option>
          </select>

          <hr>
          <div><strong>Providers:</strong> <span id="provider-count">480</span></div>
          <div style="margin-top:8px"><strong>Savings Opp:</strong> <span id="savings-opp">9 contracts (~$7.4M)</span></div>
          <div style="margin-top:8px"><strong>Rate Score:</strong> <span id="rate-score">6.0 / 10</span></div>
          <div style="margin-top:8px"><strong>Adequacy:</strong> <span id="adequacy">93%</span></div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="panel">
          <h6>Key Metrics</h6>
          <div class="row">
            <div class="col-4">
              <div class="small-muted">Total Network Spend</div>
              <div style="font-weight:700; font-size:18px" id="total-spend">$150M</div>
              <div class="small-muted">Trend: Down 3% YoY</div>
            </div>
            <div class="col-4">
              <div class="small-muted">Cost Leakage</div>
              <div style="font-weight:700; font-size:18px" id="cost-leakage">$7.4M</div>
              <div class="small-muted">From rate benchmarking</div>
            </div>
            <div class="col-4">
              <div class="small-muted">Market Position</div>
              <div style="font-weight:700; font-size:18px" id="market-position">+3.6% above median</div>
              <div class="small-muted">Overpay +3.6%</div>
            </div>
          </div>
        </div>

        <div class="panel" style="padding:14px;">
          <!-- Map container with legend overlay -->
          <div class="map-container">
            <div id="map"></div>
            <!-- Legend positioned absolutely on top of map -->
            <div class="map-legend">
              <div class="legend-title">Heatmap: Intensity = Overpay × Impact</div>
              <div class="legend-row">
                <span class="legend-swatch" style="background:#ef4444"></span>
                <div class="legend-text">Hot: High overpay & high impact</div>
              </div>
              <div class="legend-row">
                <span class="legend-swatch" style="background:#f59e0b"></span>
                <div class="legend-text">Warm: Moderate risk</div>
              </div>
              <div class="legend-row">
                <span class="legend-swatch" style="background:#7dd3fc"></span>
                <div class="legend-text">Cool: Low impact / on-market</div>
              </div>
              <div class="legend-note">Tip: click a marker to see contextual AI suggestions; heat intensity normalised within the selected region.</div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-3">
        <div class="panel panel-eq">
          <h6>Market Intelligence & AI</h6>

          <!-- Chat & Insights compact area (keeps panel size similar) -->
          <div style="display:flex; flex-direction:column; gap:10px;">
            <!-- Chat box -->
            <div>
              <label class="small-muted" style="font-weight:700">AI Assistant (Ask a question)</label>
              <div class="chat-box" id="chat-box">
                <!-- chat messages injected here -->
              </div>
              <div style="display:flex; gap:8px; margin-top:8px;">
                <input id="chat-input" class="form-control form-control-sm" placeholder="e.g., Which state is highest risk?" />
                <button id="chat-send" class="btn btn-sm btn-primary">Send</button>
              </div>
              <div style="display:flex; gap:8px; align-items:center; margin-top:8px;">
                <div class="form-check form-switch mb-0">
                  <input class="form-check-input" type="checkbox" id="use-llm">
                  <label class="form-check-label small-muted" for="use-llm">Use LLM (optional)</label>
                </div>
                <button id="run-scan" class="btn btn-sm btn-outline-success">Run quick scan</button>
              </div>
            </div>

            <!-- Insights list -->
            <div>
              <label class="small-muted" style="font-weight:700">AI Domain Insights</label>
              <div id="insights-feed" style="max-height:120px; overflow:auto; border-radius:6px; padding:8px; border:1px solid #eef2ff; background:#fff;"></div>
              <div style="display:flex; gap:8px; margin-top:8px;">
                <button id="refresh-insights" class="btn btn-sm btn-outline-primary">Refresh</button>
                <button id="export-insights" class="btn btn-sm btn-outline-secondary">Export</button>
              </div>
            </div>

            <div style="margin-top:auto; font-size:13px; color:var(--muted);">Tip: click a state on map to filter rate table and get contextual suggestions.</div>
          </div>

        </div>
      </div>
    </div>

    <!-- middle row -->
    <div class="row g-3 mt-2">
      <div class="col-md-4">
        <div class="panel panel-eq">
          <h6>Financial Strength <small class="small-muted">Score: 72/100</small></h6>
          <div class="scroll-table" id="financial-table"></div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="panel panel-eq">
          <h6>Rate Benchmarking <small class="small-muted">Score: 65/100</small></h6>
          <div class="scroll-table" id="rate-table"></div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="panel panel-eq">
          <h6>Provider Quality <small class="small-muted">Score: 87/100</small></h6>
          <div id="quality-plot"></div>
        </div>
      </div>
    </div>

    <!-- scenario & goals -->
    <div class="row g-3 mt-3">
      <div class="col-lg-9">
        <div class="scenario-box panel d-flex gap-3">
          <div class="scenario-controls">
            <div style="font-weight:700; margin-bottom:8px;">Scenario Planner — What if I cut rates?</div>
            <label class="small-muted">Specialty</label>
            <select id="scenario-specialty" class="form-select form-select-sm mb-2">
              <option>Cardiology</option>
              <option>Orthopedics</option>
              <option>Radiology</option>
              <option>Primary Care</option>
            </select>
            <label class="small-muted">Rate Change (%)</label>
            <input id="scenario-slider" type="range" min="-10" max="10" value="-6" class="form-range mb-1">
            <div style="color:var(--accent); font-weight:700;" id="slider-value">-6%</div>
          </div>

          <div class="scenario-results" id="scenario-result"></div>
        </div>
      </div>

      <div class="col-lg-3">
        <div class="panel panel-eq">
          <h6>Strategic Goals</h6>
          <div class="small-muted">Cost Reduction</div>
          <div style="font-weight:700; font-size:16px">$9.2M / $15M</div>
          <div class="progress mb-3" style="height:12px"><div class="progress-bar bg-primary" style="width:61%; background-color:var(--hi-blue)!important">61%</div></div>
          <div class="small-muted">CMS Adequacy</div>
          <div style="font-weight:700; font-size:16px">92%</div>
          <div class="progress mb-3" style="height:12px"><div class="progress-bar bg-primary" style="width:92%; background-color:var(--hi-blue)!important">92%</div></div>
        </div>
      </div>
    </div>

    <div class="footer">Prototype (synthetic data) — HiLabs 2025 • No PHI</div>
  </div>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/plotly.js-dist@2.24.0/plotly.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.heat/0.2.0/leaflet-heat.js"></script>

  <script>
    // --- region data (kept structure) ---
    const regionData = {
      "Southwest": { center:[34.5,-111.5], zoom:6, states:[
        {s:"AZ", n:"Arizona", v:9, pos:[34.2,-111.7], impact:85, save:2.1},
        {s:"NM", n:"New Mexico", v:7, pos:[34.5,-106.0], impact:42, save:0.9},
        {s:"NV", n:"Nevada", v:11, pos:[39.0,-116.0], impact:58, save:1.8}
      ]},
      "New England": { center:[43.5,-71.5], zoom:7, states:[
        {s:"MA", n:"Massachusetts", v:8, pos:[42.4,-71.4], impact:95, save:2.4},
        {s:"CT", n:"Connecticut", v:10, pos:[41.6,-72.7], impact:62, save:1.6},
        {s:"RI", n:"Rhode Island", v:6, pos:[41.7,-71.5], impact:28, save:0.7},
        {s:"NH", n:"New Hampshire", v:5, pos:[43.7,-71.5], impact:35, save:0.9}
      ]},
      "Pacific Northwest": { center:[45.5,-122], zoom:6, states:[
        {s:"WA", n:"Washington", v:7, pos:[47.5,-120.5], impact:78, save:1.9},
        {s:"OR", n:"Oregon", v:9, pos:[43.9,-120.6], impact:55, save:1.4},
        {s:"CA", n:"Northern California", v:12, pos:[40.5,-122], impact:125, save:3.2}
      ]},
      "Great Lakes": { center:[42,-85], zoom:6, states:[
        {s:"IL", n:"Illinois", v:10, pos:[40,-89], impact:105, save:2.8},
        {s:"MI", n:"Michigan", v:8, pos:[44.3,-85.6], impact:72, save:1.8},
        {s:"OH", n:"Ohio", v:9, pos:[40.4,-82.9], impact:88, save:2.2}
      ]},
      "Southeast": { center:[30.5,-82], zoom:6, states:[
        {s:"FL", n:"Florida", v:11, pos:[28,-81.5], impact:145, save:3.8},
        {s:"GA", n:"Georgia", v:8, pos:[32.7,-83.5], impact:82, save:2.0},
        {s:"SC", n:"South Carolina", v:7, pos:[33.8,-81.2], impact:48, save:1.2}
      ]},
      "Mountain States": { center:[40,-111.5], zoom:6, states:[
        {s:"CO", n:"Colorado", v:9, pos:[39,-105.5], impact:92, save:2.3},
        {s:"UT", n:"Utah", v:6, pos:[39.3,-111.7], impact:45, save:1.1},
        {s:"ID", n:"Idaho", v:5, pos:[44,-114.7], impact:32, save:0.8}
      ]}
    };

    const networkMetrics = {
      "Great Plains Care Connect": {spend:280, leakage:15.2, pos:"+8.1%"},
      "PacificCare Integrated Health": {spend:420, leakage:22.4, pos:"+10.5%"},
      "Midwest Regional Medical": {spend:310, leakage:13.6, pos:"+5.8%"},
      "Tri-State Wellness": {spend:245, leakage:12.3, pos:"+6.2%"},
      "Northeast Community Health": {spend:360, leakage:18.0, pos:"+9.0%"},
      "Southern Cross Healthcare": {spend:200, leakage:9.8, pos:"+4.2%"},
      "Bayview Specialty Health": {spend:150, leakage:7.4, pos:"+3.6%"},
      "Rocky Mountain Health": {spend:95, leakage:4.5, pos:"+2.0%"}
    };

    // --- map + heatmap setup ---
    const map = L.map('map', {zoomControl:true, scrollWheelZoom:false}).setView([42,-85],6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'© OpenStreetMap', maxZoom:19 }).addTo(map);

    let heatLayer = null;
    let markerLayer = L.layerGroup().addTo(map);

    function colorFor(v){ if(v>10) return '#ef4444'; if(v>5) return '#f59e0b'; return '#10b981'; }

    function buildHeatPoints(states){
      // Each point: [lat, lng, intensity], intensity normalized within the region
      const raw = states.map(s => ({lat:s.pos[0], lng:s.pos[1], score: s.v * s.impact}));
      const maxScore = Math.max(...raw.map(r=>r.score), 1);
      return raw.map(r => [r.lat, r.lng, Math.min(1, r.score / maxScore)]);
    }

    function updateMap(regionKey){
      markerLayer.clearLayers();
      if(heatLayer){ map.removeLayer(heatLayer); heatLayer = null; }
      const data = regionData[regionKey];
      if(!data) return;
      map.flyTo(data.center, data.zoom, {duration:0.8});
      const heatPoints = buildHeatPoints(data.states);
      heatLayer = L.heatLayer(heatPoints, {radius: 40, blur: 30, maxZoom: 12, gradient:{0.2:'blue',0.5:'orange',0.9:'red'}}).addTo(map);

      // smaller interactive markers remain for clicking
      data.states.forEach(st => {
        const m = L.circleMarker(st.pos, { radius:8, fillColor: colorFor(st.v), fillOpacity:0.95, color:'#fff', weight:1 }).addTo(markerLayer);
        m.bindTooltip(`<div style="font-weight:600">${st.n} (${st.s})</div>Overpay: ${st.v}%<br>Impact: $${st.impact}M<br>Savings: $${st.save}M`);
        m.on('click', ()=> {
          // When clicked, show contextual suggestions in chat & filter rate table
          showContextualSuggestions(st, regionKey);
          filterRateTableByState(st);
        });
      });
    }

    // initialize
    updateMap("Great Lakes");
    document.getElementById('coverage-area').addEventListener('change', e=> { updateMap(e.target.value); runQuickScan(); });

    // --- render tables/plots (unchanged style) ---
    const financialRows = [
      {m:"Net Network Revenue", v:"$3.123B", p:"99th", s:"Excellent"},
      {m:"Avg Provider Margins", v:"-5.1%", p:"31st", s:"Below Avg"},
      {m:"Net Operating Profit", v:"11.8%", p:"6th", s:"Poor"},
      {m:"Days Outstanding", v:"39.1", p:"72nd", s:"Average"},
      {m:"Network Savings Identified", v:"$12.3M", p:"68th", s:"Above Avg"}
    ];
    const rateRows = [
      {sp:"Cardiology (Office)", cur:420, med:390, pct:75, st:"OVERPAYING", sav:"$150K/provider"},
      {sp:"Orthopedics", cur:380, med:350, pct:80, st:"OVERPAYING", sav:"$120K/provider"},
      {sp:"Primary Care", cur:185, med:175, pct:60, st:"MODERATE", sav:"$95K/provider"},
      {sp:"Radiology (MRI)", cur:520, med:475, pct:82, st:"OVERPAYING", sav:"$180K"},
      {sp:"General Surgery", cur:680, med:620, pct:77, st:"OVERPAYING", sav:"$140K"}
    ];

    function renderFinancial(){
      const el = document.getElementById('financial-table');
      let html = '<table class="table table-sm"><thead><tr><th>Metric</th><th>Value</th><th>Percentile</th><th>Status</th></tr></thead><tbody>';
      financialRows.forEach(r => html += `<tr><td>${r.m}</td><td>${r.v}</td><td>${r.p}</td><td>${r.s}</td></tr>`);
      html += '</tbody></table>'; el.innerHTML = html;
    }
    function renderRateTable(filtered=null){
      const el = document.getElementById('rate-table');
      let html = '<table class="table table-sm"><thead><tr><th>Specialty</th><th>Current</th><th>Median</th><th>Pctl</th><th>Status</th><th>Savings</th></tr></thead><tbody>';
      const rows = filtered || rateRows;
      rows.forEach(r => html += `<tr><td>${r.sp}</td><td>$${r.cur}</td><td>$${r.med}</td><td>${r.pct}th</td><td>${r.st}</td><td>${r.sav}</td></tr>`);
      html += '</tbody></table>'; el.innerHTML = html;
    }
    function filterRateTableByState(st){
      // lightweight filter: if state has high overpay, show OVERPAYING specialties; else show all
      if(st.v >= 9){
        const filtered = rateRows.filter(r => r.st.includes('OVERPAYING'));
        renderRateTable(filtered);
        appendChat('assistant', `Filtered rate table for ${st.n}: showing top OVERPAYING specialties.`);
      } else {
        renderRateTable();
        appendChat('assistant', `State ${st.n} has lower overpay; showing full rate table.`);
      }
    }
    function renderQuality(){
      const rows = [
        {x:90,y:15,label:"Ortho Surgery Center X"},
        {x:75,y:85,label:"North Cardiology Clinic"},
        {x:82,y:72,label:"Metro Radiology"},
        {x:60,y:78,label:"Community PCP Group"},
        {x:50,y:49,label:"Rural Health Center"}
      ];
      const data = [{ x: rows.map(r=>r.x), y: rows.map(r=>r.y), text: rows.map(r=>r.label), mode:'markers', marker:{ size:12, color: rows.map(r=> r.y>=80 ? '#2c6aef':'#f59e0b') } }];
      const layout = { margin:{t:8,l:40,r:8,b:30}, xaxis:{title:'Cost Percentile'}, yaxis:{title:'Quality Percentile'}, hovermode:'closest' };
      Plotly.newPlot('quality-plot', data, layout, {displayModeBar:false, responsive:true});
    }

    // scenario logic (kept)
    const slider = document.getElementById('scenario-slider');
    const sliderValue = document.getElementById('slider-value');
    const scenarioResult = document.getElementById('scenario-result');

    function updateScenario(){
      const cut = Number(slider.value);
      sliderValue.innerText = (cut>0?'+':'') + cut + '%';
      const specialty = document.getElementById('scenario-specialty').value;
      const baseM = 150;
      const savings = Math.round(Math.abs(cut) * 1.3 * 100)/100;
      const exitRisk = Math.min(100, Math.round(Math.abs(cut)*3 + 2));
      const adequacyAfter = Math.max(78, 92 - Math.round(Math.max(0, (Math.abs(cut)-3)*1.5)));

      scenarioResult.innerHTML = `<div style="font-weight:700; margin-bottom:8px;">Specialty: ${specialty} &nbsp; Cut: ${cut}%</div>
        <table class="table table-sm mb-2"><thead><tr><th>Metric</th><th>Before</th><th>After</th></tr></thead>
        <tbody>
          <tr><td>Total Spend</td><td>$${baseM}M</td><td>$${(baseM - savings).toFixed(2)}M</td></tr>
          <tr><td>Projected Savings</td><td>—</td><td><strong>$${savings}M</strong></td></tr>
          <tr><td>Provider Exit Risk</td><td>—</td><td>${exitRisk}%</td></tr>
          <tr><td>Network Adequacy</td><td>92%</td><td>${adequacyAfter}%</td></tr>
        </tbody></table>
        <div class="alert alert-info mb-0"><strong>Recommendation:</strong> Consider smaller cut (e.g., 4%) or recruit providers to maintain adequacy.</div>`;
    }

    slider.addEventListener('input', updateScenario);
    document.getElementById('scenario-specialty').addEventListener('change', updateScenario);

    // ---------------- AI: Predictor (client-side linear reg) ----------------
    function linreg(xs, ys){
      const n = xs.length;
      const mx = xs.reduce((a,b)=>a+b,0)/n;
      const my = ys.reduce((a,b)=>a+b,0)/n;
      let num=0, den=0, ssTot=0, ssRes=0;
      for(let i=0;i<n;i++){ num += (xs[i]-mx)*(ys[i]-my); den += (xs[i]-mx)*(xs[i]-mx); }
      const slope = den===0 ? 0 : num/den;
      const intercept = my - slope*mx;
      for(let i=0;i<n;i++){ ssTot += (ys[i]-my)*(ys[i]-my); ssRes += (ys[i] - (slope*xs[i]+intercept))**2; }
      const r2 = ssTot===0 ? 1 : Math.max(0, 1 - ssRes/ssTot);
      return {slope, intercept, r2};
    }

    function synthHistory(metricKey, months){
      const base = { costLeakage:7.4, providerCount:480, totalSpend:150 };
      const trend = { costLeakage: -0.05, providerCount: 2, totalSpend: -0.4 };
      const series = [];
      for(let i=months-1;i>=0;i--){
        const noise = (Math.random()-0.5) * (metricKey==='costLeakage' ? 0.9 : metricKey==='totalSpend' ? 2.5 : 6);
        const val = Math.max(0, base[metricKey] + trend[metricKey]*i + noise);
        series.push(Number(val.toFixed(2)));
      }
      return series;
    }

    function runPredictorInline(metricKey='costLeakage', months=12){
      const hist = synthHistory(metricKey, months);
      const xs = Array.from({length:months}, (_,i)=>i);
      const ys = hist.slice();
      const model = linreg(xs, ys);
      const preds = [];
      for(let k=0;k<3;k++){ const x = months + k; preds.push(Number((model.slope*x + model.intercept).toFixed(2))); }
      // Plot inside existing quality plot area if available OR create minimal inline chart area
      const chartDivId = 'predictor-overlay';
      // create overlay panel if not exists
      let overlay = document.getElementById(chartDivId);
      if(!overlay){
        overlay = document.createElement('div'); overlay.id = chartDivId;
        overlay.style.height = '220px'; overlay.style.marginTop = '10px';
        // place it under Key Metrics area (insert after map panel)
        const keyMetricsPanel = document.querySelector('.panel[style*="padding:14px;"]');
        if(keyMetricsPanel && keyMetricsPanel.parentNode) {
          keyMetricsPanel.parentNode.insertBefore(overlay, keyMetricsPanel.nextSibling);
        } else {
          document.querySelector('.container-fluid').appendChild(overlay);
        }
      }
      const traceHist = { x: xs.map(i=>i - months + 1), y: ys, mode:'lines+markers', name:'History' };
      const tracePred = { x: [1,2,3], y: preds, mode:'lines+markers', name:'Prediction', line:{dash:'dash'} };
      const layout = { margin:{t:10,l:40,r:10,b:30}, yaxis:{title: metricKey==='costLeakage'? 'Cost Leakage (M)': metricKey==='totalSpend'? 'Total Spend (M)' : 'Provider Count'} };
      Plotly.newPlot(chartDivId, [traceHist, tracePred], layout, {displayModeBar:false});
      return {preds, r2: model.r2};
    }

    // Add a small predictor quick access in the Market Intelligence panel
    // Create controls programmatically to avoid changing HTML structure too much
    (function addPredictorControls(){
      const panel = document.querySelector('#chat-box')?.parentNode;
      if(!panel) return;
      const node = document.createElement('div');
      node.style.marginTop = '8px';
      node.innerHTML = `
        <div style="display:flex;gap:6px;align-items:center;">
          <select id="quick-pred-metric" class="form-select form-select-sm" style="width:160px;">
            <option value="costLeakage">Cost Leakage (M)</option>
            <option value="providerCount">Provider Count</option>
            <option value="totalSpend">Total Spend (M)</option>
          </select>
          <input id="quick-pred-months" type="number" min="6" max="36" value="12" class="form-control form-control-sm" style="width:90px;">
          <button id="quick-pred-run" class="btn btn-sm btn-outline-primary">Predict</button>
        </div>
        <div id="quick-pred-summary" style="font-size:13px;color:var(--muted);margin-top:6px;"></div>
      `;
      panel.appendChild(node);
      document.getElementById('quick-pred-run').addEventListener('click', ()=> {
        const metric = document.getElementById('quick-pred-metric').value;
        const months = Number(document.getElementById('quick-pred-months').value) || 12;
        const res = runPredictorInline(metric, months);
        document.getElementById('quick-pred-summary').innerText = `Next 3-month forecast: ${res.preds.join(', ')} (R² ${(res.r2*100).toFixed(0)}%)`;
      });
    })();

    // ---------------- AI Assistant chat (rule-based) ----------------
    const chatBox = document.getElementById('chat-box');
    function appendChat(role, text){
      const row = document.createElement('div'); row.className = 'chat-row ' + (role==='user'?'chat-user':'chat-assistant');
      row.innerHTML = `<div class="chat-bubble">${text}</div>`;
      chatBox.appendChild(row); chatBox.scrollTop = chatBox.scrollHeight;
    }

    async function handleChat(q){
      appendChat('user', q);
      appendChat('assistant', 'Thinking...');
      const useLLM = document.getElementById('use-llm').checked;
      const region = document.getElementById('coverage-area').value;
      const context = { region, topSpecialty: rateRows[0].sp, lastScenario: { slider: document.getElementById('scenario-slider').value } };

      const lq = q.toLowerCase();
      if(!useLLM){
        let reply = '';
        if(lq.includes('which state') || lq.includes('highest risk') || lq.includes('biggest risk')){
          const area = regionData[region];
          const ranked = area.states.map(s=>({...s, score: s.v * s.impact})).sort((a,b)=>b.score - a.score);
          const t = ranked[0];
          reply = `Biggest regional risk is ${t.n} (${t.s}) with ${t.v}% overpayment and $${t.impact}M impact. Suggested actions: targeted RFPs and coding audits.`;
        } else if(lq.includes('which specialty') || lq.includes('specialty to target')){
          reply = `Based on benchmarking, start with ${rateRows[0].sp}. Recommend a targeted RFP and provider triage by volume.`;
        } else if(lq.includes('predict') || lq.includes('forecast')){
          reply = `Use the Predict control (in Market Intelligence) to run a 3-month linear forecast. It returns R² as a confidence proxy.`;
        } else if(lq.includes('what is the biggest risk')){
          const area = regionData[region];
          const ranked = area.states.map(s=>({...s, score: s.v * s.impact})).sort((a,b)=>b.score - a.score);
          reply = `Automated scan: ${ranked[0].n} is highest by combined overpay×impact. Consider immediate negotiation and adequacy protections.`;
        } else {
          reply = `I can answer: "Which state is highest risk", "Which specialty to target", or explain how to run a forecast. Try one of those, or enable "Use LLM" to call your model (endpoint hook available).`;
        }
        // replace last assistant "Thinking..." bubble
        chatBox.lastChild.innerHTML = `<div class="chat-bubble">${reply}</div>`;
      } else {
        // LLM hook: user must plug in serverless endpoint or model endpoint
        // This block attempts to call endpoint saved in data-attributes if configured.
        const endpoint = document.getElementById('llm-endpoint') ? document.getElementById('llm-endpoint').value.trim() : '';
        const key = document.getElementById('llm-key') ? document.getElementById('llm-key').value.trim() : '';
        if(!endpoint){
          chatBox.lastChild.innerHTML = `<div class="chat-bubble">LLM endpoint not configured. Please set up an endpoint to use the LLM option.</div>`;
          return;
        }
        try {
          const payload = { prompt: `Context: ${JSON.stringify(context)}\nUser: ${q}\nAssistant:`, max_tokens: 300 };
          const headers = { 'Content-Type':'application/json' };
          if(key) headers['Authorization'] = `Bearer ${key}`;
          const res = await fetch(endpoint, { method:'POST', headers, body: JSON.stringify(payload) });
          const json = await res.json();
          let text = '';
          if(json.choices && json.choices[0] && (json.choices[0].text || json.choices[0].message)) {
            text = json.choices[0].text || (json.choices[0].message && json.choices[0].message.content) || JSON.stringify(json.choices[0]).slice(0,800);
          } else if(json.output && typeof json.output === 'string') text = json.output;
          else text = JSON.stringify(json).slice(0,800);
          chatBox.lastChild.innerHTML = `<div class="chat-bubble">${text}</div>`;
        } catch(err){
          chatBox.lastChild.innerHTML = `<div class="chat-bubble">LLM call failed: ${err.message}</div>`;
        }
      }
    }

    document.getElementById('chat-send').addEventListener('click', ()=>{
      const q = document.getElementById('chat-input').value.trim();
      if(!q) return;
      document.getElementById('chat-input').value = '';
      handleChat(q);
    });

    // If user toggles LLM, create input fields for endpoint & key in a small unobtrusive way
    (function addLLMInputs(){
      const cont = document.querySelector('.panel.panel-eq');
      if(!cont) return;
      const holder = document.createElement('div'); holder.style.marginTop = '6px';
      holder.innerHTML = `<div id="llm-config" style="display:none; gap:6px;">
        <input id="llm-endpoint" class="form-control form-control-sm mb-1" placeholder="LLM endpoint (POST)" />
        <input id="llm-key" class="form-control form-control-sm" placeholder="API key (optional)" />
      </div>`;
      cont.appendChild(holder);
      const useLlm = document.getElementById('use-llm');
      useLlm.addEventListener('change', (e)=> {
        document.getElementById('llm-config').style.display = e.target.checked ? 'flex' : 'none';
      });
    })();

    // ---------------- Insights feed (synthetic + auto-insights) ----------------
    const insightsEl = document.getElementById('insights-feed');
    const syntheticInsights = [
      {title:'Specialty RFPs accelerate savings', src:'HiLabs AI', time:'2h ago', summary:'Pilot RFPs in cardiology show 12% average rate reduction with maintained adequacy.'},
      {title:'Coding audits find systematic upcoding', src:'Domain Monitor', time:'6h ago', summary:'Initial audits in 3 states found coding mismatches driving 4–6% rate inflation.'},
      {title:'Provider consolidation increases leverage', src:'HealthNews', time:'1d ago', summary:'Consolidation in ortho led to +9% price premium vs independent clinics.'}
    ];

    function renderInsights(items = syntheticInsights){
      insightsEl.innerHTML = '';
      items.forEach(it => {
        const div = document.createElement('div'); div.className = 'news-item';
        div.style.marginBottom = '8px';
        div.innerHTML = `<div style="font-weight:700">${it.title}</div><div style="font-size:12px;color:var(--muted)">${it.src} • ${it.time}</div><div style="margin-top:6px">${it.summary}</div>`;
        insightsEl.appendChild(div);
      });
    }
    renderInsights();

    document.getElementById('refresh-insights').addEventListener('click', ()=> {
      // auto-insight combining top region risk
      const region = document.getElementById('coverage-area').value;
      const area = regionData[region];
      if(area){
        const top = area.states.slice().sort((a,b)=> (b.v*b.impact) - (a.v*a.impact))[0];
        const auto = { title: `Automated Insight: ${top.n} top risk`, src:'HiLabs AI', time:'now', summary: `${top.n} shows ${top.v}% overpayment with $${top.impact}M impact. Consider targeted RFP + coding audit.` };
        renderInsights([auto, ...syntheticInsights]);
        appendChat('assistant', `Refreshed insights: ${top.n} flagged as highest impact.`);
      } else {
        renderInsights();
      }
    });

    document.getElementById('export-insights').addEventListener('click', ()=>{
      const nodes = Array.from(document.querySelectorAll('#insights-feed .news-item'));
      const rows = nodes.map(n => {
        const title = n.children[0].innerText;
        const meta = n.children[1].innerText;
        const summary = n.children[2].innerText;
        return `"${title.replace(/"/g,'""')}","${meta.replace(/"/g,'""')}","${summary.replace(/"/g,'""')}"`;
      });
      const csv = 'title,meta,summary\n' + rows.join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'insights.csv'; a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    // ---------------- Quick AI scan (heuristic) ----------------
    function showContextualSuggestions(stateObj, regionKey){
      const text = `Contextual suggestions for ${stateObj.n}: Overpay ${stateObj.v}%, Impact $${stateObj.impact}M. Recommend: 1) coding audit 2) targeted RFPs 3) adequacy protections.`;
      appendChat('assistant', text);
      // insert a compact insight
      const item = { title:`Automated: ${stateObj.n} priority`, src:'HiLabs AI', time:'now', summary:`Overpay ${stateObj.v}%, impact $${stateObj.impact}M.` };
      const div = document.createElement('div'); div.className='news-item';
      div.style.marginBottom = '8px';
      div.innerHTML = `<div style="font-weight:700">${item.title}</div><div style="font-size:12px;color:var(--muted)">${item.src} • ${item.time}</div><div style="margin-top:6px">${item.summary}</div>`;
      insightsEl.insertBefore(div, insightsEl.firstChild);
    }

    function runQuickScan(){
      const areaKey = document.getElementById('coverage-area').value;
      const area = regionData[areaKey];
      if(!area) return;
      const ranked = area.states.map(s => ({...s, score: s.v * s.impact})).sort((a,b)=>b.score - a.score);
      appendChat('assistant', `Quick scan for ${areaKey}: Top priority ${ranked[0].n} (score ${Math.round(ranked[0].score)}). Insights panel updated.`);
      const top = ranked[0];
      const item = { title:`QuickScan: ${top.n} top risk`, src:'HiLabs AI', time:'now', summary:`${top.n} — overpay ${top.v}%, impact $${top.impact}M.` };
      const div = document.createElement('div'); div.className='news-item';
      div.style.marginBottom = '8px';
      div.innerHTML = `<div style="font-weight:700">${item.title}</div><div style="font-size:12px;color:var(--muted)">${item.src} • ${item.time}</div><div style="margin-top:6px">${item.summary}</div>`;
      insightsEl.insertBefore(div, insightsEl.firstChild);
    }

    document.getElementById('run-scan').addEventListener('click', runQuickScan);

    // ----------------- Boot -----------------
    function init(){
      renderFinancial(); renderRateTable(); renderQuality(); updateScenario();
      // initial chat greeting
      appendChat('assistant', 'Hi — HiLabs Assistant here. Ask about region risk, specialty picks, or run a forecast. Click a state on the heatmap to get contextual suggestions.');
      // initial snapshot scan
      runQuickScan();
    }
    init();

    // ----------------- small UI polish: network selection updates -----------------
    document.getElementById('network-name').addEventListener('change', function(e){
      const key = e.target.value;
      const m = networkMetrics[key] || networkMetrics["Bayview Specialty Health"];
      document.getElementById('total-spend').innerText = `$${m.spend}M`;
      document.getElementById('cost-leakage').innerText = `$${m.leakage}M`;
      document.getElementById('market-position').innerText = m.pos + ' above median';
      document.getElementById('provider-count').innerText = Math.max(60, Math.round(m.spend * 3.2));
      document.getElementById('savings-opp').innerText = `${Math.max(5, Math.round(m.leakage/0.8))} contracts (~$${m.leakage.toFixed(1)}M)`;
      document.getElementById('rate-score').innerText = `${Math.max(5,(10 - Math.round(m.leakage/2))).toFixed(1)} / 10`;
      document.getElementById('adequacy').innerText = `${Math.max(85, 95 - Math.round(m.leakage/3))}%`;
      // refresh map & insights
      updateMap(document.getElementById('coverage-area').value);
      runQuickScan();
    });

  </script>
</body>
</html>
