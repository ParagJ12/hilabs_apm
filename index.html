<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>HiLabs — AI-enhanced Dashboard (Heatmap + Predictor + Chat)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root{ --hi-blue:#2c6aef; --hi-bg:#f8f9fa; --panel-bg:#fff; --muted:#6b7280; --accent:#2c6aef; }
    html,body { height:100%; } body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; background:var(--hi-bg); margin:0; color:#0b1220; }
    .container-fluid { padding:18px; max-width:1400px; margin:auto; }
    .header { padding:14px 18px; background:var(--hi-blue); color:#fff; border-radius:10px; margin-bottom:14px; display:flex; align-items:center; justify-content:space-between; gap:12px; box-shadow:0 6px 18px rgba(44,106,239,0.12); }
    .kpi-group { display:flex; gap:10px; align-items:center; flex-wrap:nowrap; overflow-x:auto; padding-left:6px; }
    .kpi { background:var(--panel-bg); border-radius:8px; padding:10px 12px; min-width:150px; text-align:center; box-shadow:0 2px 6px rgba(2,6,23,0.06); border-left:4px solid var(--accent); }
    .panel { background:var(--panel-bg); padding:14px; border-radius:10px; box-shadow:0 4px 10px rgba(2,6,23,0.04); border-left:4px solid var(--accent); }
    .map-container { position: relative; height:360px; border-radius:8px; overflow:hidden; }
    #map { height:100%; width:100%; border-radius:8px; border:1px solid #e6edf8; }
    .map-legend { position:absolute; top:10px; right:10px; z-index:1000; background:rgba(255,255,255,0.98); padding:10px 12px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.15); border-left:3px solid var(--accent); font-size:12px; min-width:180px; }
    .ai-pane { margin-top:12px; display:flex; flex-direction:column; gap:8px; }
    .ai-suggestion { border-left:4px solid #ef4444; padding:10px; border-radius:6px; background:#fff; box-shadow:0 2px 8px rgba(2,6,23,0.04); }
    .chat-box { height:280px; overflow:auto; border:1px solid #eef2ff; padding:8px; border-radius:8px; background:#fff; }
    .chat-row { margin-bottom:8px; }
    .chat-user{ text-align:right; } .chat-assistant{ text-align:left; }
    .news-item{ padding:8px; border-bottom:1px dashed #eef2ff; }
    .predictor-controls { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    @media (max-width:1100px){ .header{ flex-direction:column; align-items:flex-start; gap:12px; } .map-container{ height:300px } }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="header">
      <div>
        <h4>HiLabs | Risk & Rate Intelligence — AI Edition</h4>
        <div style="font-size:13px; color:rgba(255,255,255,0.95)">User: Jenifer Hayes — AI features: Predictor, Chatbot, Insights</div>
      </div>
      <div class="kpi-group">
        <div class="kpi"><div style="font-size:12px;color:var(--muted)">Patient Sat</div><div style="font-weight:700;font-size:18px">81/100</div></div>
        <div class="kpi"><div style="font-size:12px;color:var(--muted)">Provider ROI</div><div style="font-weight:700;font-size:18px">112.6%</div></div>
        <div class="kpi"><div style="font-size:12px;color:var(--muted)">Accessibility</div><div style="font-weight:700;font-size:18px">58/100</div></div>
      </div>
    </div>

    <!-- top row -->
    <div class="row g-3">
      <div class="col-lg-3">
        <div class="panel">
          <h6>Network Controls</h6>
          <label class="small-muted">Network</label>
          <select id="network-name" class="form-select form-select-sm mb-2">
            <option selected>Bayview Specialty Health</option>
            <option>PacificCare Integrated Health</option>
            <option>Midwest Regional Medical</option>
          </select>
          <label class="small-muted">Coverage Area</label>
          <select id="coverage-area" class="form-select form-select-sm mb-2">
            <option value="Great Lakes" selected>Great Lakes</option>
            <option value="Southeast">Southeast</option>
            <option value="Pacific Northwest">Pacific Northwest</option>
          </select>
          <hr />
          <div><strong>Providers:</strong> <span id="provider-count">480</span></div>
          <div><strong>Cost Leakage:</strong> <span id="cost-leakage">$7.4M</span></div>
          <div><strong>Rate Score:</strong> <span id="rate-score">6.0 / 10</span></div>
          <button id="run-scan" class="btn btn-sm btn-outline-success mt-3">Run quick AI scan</button>
        </div>
        
        <div class="panel mt-3">
          <h6>AI Domain Insights</h6>
          <div id="insights-feed" style="max-height:230px; overflow:auto;">
            <!-- populated via JS -->
          </div>
          <div class="d-flex gap-2 mt-2">
            <button id="refresh-insights" class="btn btn-sm btn-primary">Refresh</button>
            <button id="export-insights" class="btn btn-sm btn-outline-secondary">Export</button>
          </div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="panel">
          <h6>Regional Heatmap (click markers for suggestions)</h6>
          <div class="map-container">
            <div id="map"></div>
            <div class="map-legend">
              <div style="font-weight:700">Heat = Overpay × Impact</div>
              <div style="margin-top:6px"><small class="small-muted">Red = high; Orange = med; Blue = low</small></div>
            </div>
          </div>
        </div>

        <div class="panel mt-3">
          <h6>Metric Predictor</h6>
          <div class="predictor-controls">
            <label class="small-muted mb-0">Metric</label>
            <select id="predictor-metric" class="form-select form-select-sm" style="width:180px;">
              <option value="costLeakage">Cost Leakage (M)</option>
              <option value="providerCount">Provider Count</option>
              <option value="totalSpend">Total Spend (M)</option>
            </select>
            <label class="small-muted mb-0">History months</label>
            <input id="history-months" type="number" min="6" max="36" value="12" class="form-control form-control-sm" style="width:90px;">
            <button id="run-predictor" class="btn btn-sm btn-primary">Predict 3 months</button>
          </div>
          <div id="predictor-chart" style="height:300px; margin-top:10px"></div>
          <div id="predictor-summary" style="margin-top:8px; color:var(--muted)"></div>
        </div>
      </div>

      <div class="col-lg-3">
        <div class="panel">
          <h6>AI Assistant (Chat)</h6>
          <div class="chat-box" id="chat-box"></div>
          <div style="display:flex; gap:6px; margin-top:8px;">
            <input id="chat-input" class="form-control form-control-sm" placeholder="Ask: e.g., Which state is highest risk?" />
            <button id="chat-send" class="btn btn-sm btn-primary">Send</button>
          </div>
          <div class="form-check form-switch mt-2">
            <input class="form-check-input" type="checkbox" id="use-llm">
            <label class="form-check-label small-muted" for="use-llm">Use LLM (requires endpoint)</label>
          </div>
          <div id="llm-config" style="display:none; margin-top:8px;">
            <input id="llm-endpoint" class="form-control form-control-sm mb-1" placeholder="LLM endpoint (POST)" />
            <input id="llm-key" class="form-control form-control-sm" placeholder="API key (optional)" />
          </div>
        </div>

        <div class="panel mt-3">
          <h6>Quick Actions</h6>
          <button id="export-suggestions" class="btn btn-sm btn-outline-primary w-100 mb-2">Export suggestions</button>
          <button id="download-predictions" class="btn btn-sm btn-outline-secondary w-100">Download predictions</button>
        </div>
      </div>
    </div>

    <div style="margin-top:12px; color:var(--muted); text-align:center;">Prototype (synthetic) — HiLabs 2025 • No PHI</div>
  </div>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/plotly.js-dist@2.24.0/plotly.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.heat/0.2.0/leaflet-heat.js"></script>

  <script>
    /****************************************************************
     * Data (synthetic) - same structure as previous
     ****************************************************************/
    const regionData = {
      "Great Lakes": { center:[42,-85], zoom:6, states:[
        {s:"IL", n:"Illinois", v:10, pos:[40,-89], impact:105, save:2.8, adequacy:88},
        {s:"MI", n:"Michigan", v:8, pos:[44.3,-85.6], impact:72, save:1.8, adequacy:91},
        {s:"OH", n:"Ohio", v:9, pos:[40.4,-82.9], impact:88, save:2.2, adequacy:90}
      ]},
      "Southeast": { center:[30.5,-82], zoom:6, states:[
        {s:"FL", n:"Florida", v:11, pos:[28,-81.5], impact:145, save:3.8, adequacy:82},
        {s:"GA", n:"Georgia", v:8, pos:[32.7,-83.5], impact:82, save:2.0, adequacy:90},
        {s:"SC", n:"South Carolina", v:7, pos:[33.8,-81.2], impact:48, save:1.2, adequacy:92}
      ]},
      "Pacific Northwest": { center:[45.5,-122], zoom:6, states:[
        {s:"WA", n:"Washington", v:7, pos:[47.5,-120.5], impact:78, save:1.9, adequacy:88},
        {s:"OR", n:"Oregon", v:9, pos:[43.9,-120.6], impact:55, save:1.4, adequacy:91},
        {s:"CA", n:"Northern California", v:12, pos:[40.5,-122], impact:125, save:3.2, adequacy:83}
      ]}
    };

    const rateRows = [
      {sp:"Cardiology (Office)", cur:420, med:390, pct:75, st:"OVERPAYING", sav:"$150K/provider"},
      {sp:"Orthopedics", cur:380, med:350, pct:80, st:"OVERPAYING", sav:"$120K/provider"},
      {sp:"Primary Care", cur:185, med:175, pct:60, st:"MODERATE", sav:"$95K/provider"},
      {sp:"Radiology (MRI)", cur:520, med:475, pct:82, st:"OVERPAYING", sav:"$180K"},
      {sp:"General Surgery", cur:680, med:620, pct:77, st:"OVERPAYING", sav:"$140K"}
    ];

    /****************************************************************
     * Map + Heatmap (kept and ensured)
     ****************************************************************/
    const map = L.map('map', { zoomControl:true, scrollWheelZoom:false }).setView([42,-85],6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'© OpenStreetMap', maxZoom:19 }).addTo(map);

    let heatLayer = null;
    let markerLayer = L.layerGroup().addTo(map);

    function colorFor(v){ if(v>10) return '#ef4444'; if(v>5) return '#f59e0b'; return '#10b981'; }

    function buildHeatPoints(states){
      const raw = states.map(s => ({lat:s.pos[0], lng:s.pos[1], score: s.v * s.impact}));
      const maxScore = Math.max(...raw.map(r=>r.score), 1);
      return raw.map(r => [r.lat, r.lng, Math.min(1, r.score / maxScore)]);
    }

    function updateMap(regionKey){
      markerLayer.clearLayers();
      if(heatLayer){ map.removeLayer(heatLayer); heatLayer = null; }
      const data = regionData[regionKey];
      if(!data) return;
      map.flyTo(data.center, data.zoom, {duration:0.6});
      const heatPoints = buildHeatPoints(data.states);
      heatLayer = L.heatLayer(heatPoints, {radius: 40, blur: 30, maxZoom: 12, gradient:{0.2:'blue',0.5:'orange',0.9:'red'}}).addTo(map);
      data.states.forEach(st => {
        const marker = L.circleMarker(st.pos, { radius:8, fillColor: colorFor(st.v), fillOpacity:0.95, color:'#fff', weight:1 }).addTo(markerLayer);
        marker.bindTooltip(`<div style="font-weight:600">${st.n} (${st.s})</div>Overpay: ${st.v}%<br>Impact: $${st.impact}M<br>Savings: $${st.save}M<br>Adequacy: ${st.adequacy}%`);
        marker.on('click', ()=> { showContextualSuggestions(st, regionKey); });
      });
    }

    document.getElementById('coverage-area').addEventListener('change', e => {
      updateMap(e.target.value);
      runQuickScan();
    });
    updateMap(document.getElementById('coverage-area').value);

    /****************************************************************
     * Predictor: simple linear regression on synthetic historical series
     * - client-side, deterministic, explainable
     ****************************************************************/
    function linreg(xs, ys){
      // returns {slope, intercept, r2}
      const n = xs.length;
      const mx = xs.reduce((a,b)=>a+b,0)/n;
      const my = ys.reduce((a,b)=>a+b,0)/n;
      let num=0, den=0, ssTot=0, ssRes=0;
      for(let i=0;i<n;i++){ num += (xs[i]-mx)*(ys[i]-my); den += (xs[i]-mx)*(xs[i]-mx); }
      const slope = den===0 ? 0 : num/den;
      const intercept = my - slope*mx;
      for(let i=0;i<n;i++){ ssTot += (ys[i]-my)*(ys[i]-my); ssRes += (ys[i] - (slope*xs[i]+intercept))**2; }
      const r2 = ssTot===0 ? 1 : Math.max(0, 1 - ssRes/ssTot);
      return {slope, intercept, r2};
    }

    // synthetic historical series generator (for demo)
    function makeHistory(metricKey, months){
      // returns array of length months ending at month 0 (most recent)
      // We'll synthesize gentle trend + noise
      const base = { costLeakage:7.4, providerCount:480, totalSpend:150 };
      const trend = { costLeakage: -0.05, providerCount: 2, totalSpend: -0.4 }; // per month
      const series = [];
      for(let m = months-1; m >= 0; m--){
        const noise = (Math.random()-0.5) * (metricKey==='costLeakage' ? 0.9 : metricKey==='totalSpend' ? 2.5 : 6);
        const val = Math.max(0, base[metricKey] + trend[metricKey]*m + noise);
        series.push(Number(val.toFixed(2)));
      }
      return series;
    }

    function runPredictor(){
      const metricKey = document.getElementById('predictor-metric').value;
      const months = Number(document.getElementById('history-months').value) || 12;
      const hist = makeHistory(metricKey, months); // recent to older? we built recent first
      // x: 0..months-1
      const xs = Array.from({length:months}, (_,i)=>i);
      const ys = hist.slice(); // earliest index = oldest? our generator placed recent first; to keep it simple, assume xs ascend with indices
      const model = linreg(xs, ys);
      // predict next 3 months at x = months, months+1, months+2
      const preds = [];
      for(let k=0;k<3;k++){
        const x = months + k;
        preds.push(Number((model.slope*x + model.intercept).toFixed(2)));
      }
      // plotting: combine history (x: -months+1..0) and preds
      const traceHist = { x: xs.map(i=>i - months + 1), y: ys, mode:'lines+markers', name:'History' };
      const tracePred = { x: [1,2,3], y: preds, mode:'lines+markers', name:'Prediction', line:{dash:'dash'} };
      const layout = { margin:{t:10,l:40,r:10,b:30}, yaxis:{title: document.getElementById('predictor-metric').selectedOptions[0].text } };
      Plotly.newPlot('predictor-chart', [traceHist, tracePred], layout, {displayModeBar:false});
      const conf = Math.round(model.r2 * 100);
      document.getElementById('predictor-summary').innerText = `Next 3-month forecast: ${preds.join(', ')}. Model R² (confidence): ${conf}%. Slope: ${model.slope.toFixed(3)} per month.`;
    }

    document.getElementById('run-predictor').addEventListener('click', runPredictor);

    /****************************************************************
     * AI Assistant Chat (rule-based + hook for LLM)
     ****************************************************************/
    const chatBox = document.getElementById('chat-box');
    function appendChat(role, text){
      const row = document.createElement('div'); row.className = 'chat-row ' + (role==='user'?'chat-user':'chat-assistant');
      row.innerHTML = `<div style="display:inline-block; max-width:82%; background:${role==='user'? '#eef2ff':'#ffffff'}; padding:8px; border-radius:8px; border:1px solid #eef2ff">${text}</div>`;
      chatBox.appendChild(row); chatBox.scrollTop = chatBox.scrollHeight;
    }

    async function handleChat(q){
      appendChat('user', q);
      appendChat('assistant', 'Thinking...');
      const useLLM = document.getElementById('use-llm').checked;
      const region = document.getElementById('coverage-area').value;
      const context = { region, topRateSpecialty: rateRows[0].sp, lastScenario: { slider: document.getElementById('history-months').value } };
      // simple deterministic router for common intents
      const lq = q.toLowerCase();
      let reply = '';
      if(!useLLM){
        if(lq.includes('which state') || lq.includes('highest risk') || lq.includes('biggest risk')){
          // pick top by v*impact in selected region
          const area = regionData[region];
          const ranked = area.states.map(s=>({...s, score: s.v * s.impact})).sort((a,b)=>b.score - a.score);
          const top = ranked[0];
          reply = `Biggest regional risk is ${top.n} (${top.s}) with ${top.v}% overpayment and $${top.impact}M potential impact. Suggest targeted contract renegotiation and coding audits.`;
        } else if(lq.includes('which specialty') || lq.includes('specialty to target')){
          reply = `Based on current benchmarking, start with ${rateRows[0].sp}. Recommendation: run targeted RFP and prioritize high-volume providers.`;
        } else if(lq.includes('predict') || lq.includes('forecast')){
          reply = `Use the Predictor panel to run a linear forecast for the metric you care about (Cost Leakage, Provider Count, Total Spend). It runs client-side and gives R² as a confidence proxy.`;
        } else {
          reply = `I can answer: "Which state is highest risk", "Which specialty to target", or run a forecast. Try those, or toggle 'Use LLM' to route to an external model.`;
        }
        // replace the 'Thinking...' assistant message with final
        chatBox.lastChild.innerHTML = `<div style="display:inline-block; max-width:82%; background:#ffffff; padding:8px; border-radius:8px; border:1px solid #eef2ff">${reply}</div>`;
        chatBox.scrollTop = chatBox.scrollHeight;
      } else {
        // If user toggles LLM, attempt to call endpoint provided in UI (user must supply)
        const endpoint = document.getElementById('llm-endpoint').value.trim();
        const key = document.getElementById('llm-key').value.trim();
        if(!endpoint){
          chatBox.lastChild.innerHTML = `<div style="display:inline-block; max-width:82%; background:#fff4e6; padding:8px; border-radius:8px; border:1px solid #ffe6b3">LLM endpoint not configured. Provide endpoint URL under 'Use LLM'.</div>`;
          return;
        }
        try {
          // Construct payload: minimal context + user prompt. Replace this with your model's required shape.
          const payload = { prompt: `Context: ${JSON.stringify(context)}\n\nUser: ${q}\nAssistant:`, max_tokens: 300 };
          const headers = { 'Content-Type':'application/json' };
          if(key) headers['Authorization'] = `Bearer ${key}`;
          const res = await fetch(endpoint, { method:'POST', headers, body: JSON.stringify(payload) });
          const json = await res.json();
          // Try to extract text from common response shapes
          let text = '';
          if(json.choices && json.choices[0] && json.choices[0].text) text = json.choices[0].text;
          else if(json.output && typeof json.output === 'string') text = json.output;
          else text = JSON.stringify(json).slice(0,800);
          chatBox.lastChild.innerHTML = `<div style="display:inline-block; max-width:82%; background:#ffffff; padding:8px; border-radius:8px; border:1px solid #eef2ff">${text}</div>`;
        } catch(err){
          chatBox.lastChild.innerHTML = `<div style="display:inline-block; max-width:82%; background:#fff4e6; padding:8px; border-radius:8px; border:1px solid #ffe6b3">LLM call failed: ${err.message}</div>`;
        }
      }
    }

    document.getElementById('chat-send').addEventListener('click', ()=> {
      const q = document.getElementById('chat-input').value.trim();
      if(!q) return;
      document.getElementById('chat-input').value = '';
      handleChat(q);
    });

    // toggle LLM config visibility
    document.getElementById('use-llm').addEventListener('change', (e)=>{
      document.getElementById('llm-config').style.display = e.target.checked ? 'block' : 'none';
    });

    /****************************************************************
     * AI Domain Insights Feed (synthetic + fetch hook)
     ****************************************************************/
    const insightsEl = document.getElementById('insights-feed');
    const syntheticInsights = [
      {title:'Specialty RFPs accelerate savings', src:'HiLabs AI', time:'2h ago', summary:'Pilot RFPs in cardiology show 12% average rate reduction with maintained adequacy.'},
      {title:'Coding audits find systematic upcoding', src:'Domain Monitor', time:'6h ago', summary:'Initial audits in 3 states found coding mismatches driving 4–6% rate inflation.'},
      {title:'Provider consolidation increases leverage', src:'HealthNews', time:'1d ago', summary:'Consolidation in ortho led to +9% price premium vs independent clinics.'}
    ];

    function renderInsights(items = syntheticInsights){
      insightsEl.innerHTML = '';
      items.forEach(it => {
        const div = document.createElement('div'); div.className = 'news-item';
        div.innerHTML = `<div style="font-weight:700">${it.title}</div><div style="font-size:12px;color:var(--muted)">${it.src} • ${it.time}</div><div style="margin-top:6px">${it.summary}</div>`;
        insightsEl.appendChild(div);
      });
    }
    renderInsights();

    // Hook for fetching live news (requires API key & CORS-friendly endpoint)
    async function fetchDomainNews(apiKey){
      // Example: user can supply a NewsAPI.org key and we call it.
      // NOTE: many public news APIs require a server-side proxy for secret keys and CORS.
      // This is a simple client-side example — adapt to your infra.
      if(!apiKey) return;
      try {
        const q = encodeURIComponent('healthcare OR provider OR reimbursement OR rates');
        const url = `https://newsapi.org/v2/everything?q=${q}&language=en&sortBy=publishedAt&pageSize=5&apiKey=${apiKey}`;
        const res = await fetch(url);
        const js = await res.json();
        if(js.articles){
          const items = js.articles.map(a => ({ title: a.title, src: a.source.name, time: new Date(a.publishedAt).toLocaleString(), summary: a.description || '' }));
          renderInsights(items);
        } else {
          console.warn('news fetch result', js);
        }
      } catch(e){
        console.warn('fetchDomainNews error', e);
      }
    }

    document.getElementById('refresh-insights').addEventListener('click', ()=> {
      // by default, just reshuffle & show synthetic items + small auto commentary
      const items = syntheticInsights.map(i => ({...i, time: Math.random()>0.5? '1h ago':'3h ago'}));
      renderInsights(items);
      // Also add a small AI bullet summarizing current region risk
      const region = document.getElementById('coverage-area').value;
      const area = regionData[region];
      if(area){
        const top = area.states.slice().sort((a,b)=> (b.v*b.impact) - (a.v*a.impact))[0];
        const autoInsight = { title: `Automated Insight: ${top.n} highest impact`, src:'HiLabs AI', time:'now', summary:`${top.n} shows ${top.v}% overpayment with $${top.impact}M impact. Consider immediate coding audit & contract negotiation.` };
        renderInsights([autoInsight, ...items]);
      }
    });

    document.getElementById('export-insights').addEventListener('click', ()=>{
      const nodes = Array.from(document.querySelectorAll('#insights-feed .news-item'));
      const rows = nodes.map(n => {
        const title = n.children[0].innerText;
        const meta = n.children[1].innerText;
        const summary = n.children[2].innerText;
        return `"${title.replace(/"/g,'""')}","${meta.replace(/"/g,'""')}","${summary.replace(/"/g,'""')}"`;
      });
      const csv = 'title,meta,summary\n' + rows.join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'insights.csv'; a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    /****************************************************************
     * Quick AI scan and suggestions (existing heuristics retained)
     ****************************************************************/
    function clearAISuggestions(){ /* We'll use chat & insights panels instead */ }

    function showContextualSuggestions(stateObj, regionKey){
      // Post a suggestion into chat area (so user sees it and can ask follow-ups)
      const text = `Contextual suggestions for ${stateObj.n}: Overpay ${stateObj.v}%, Impact $${stateObj.impact}M. Recommend: 1) coding audit 2) targeted RFPs 3) adequacy protections for high-risk specialties.`;
      appendChat('assistant', text);
      // also add an automated insight card
      const item = { title:`Automated: ${stateObj.n} priority`, src:'HiLabs AI', time:'now', summary:`Overpay ${stateObj.v}%, impact ${stateObj.impact}M. Suggested actions: RFP, audit, incentives.` };
      const old = document.querySelector('#insights-feed .news-item');
      const div = document.createElement('div'); div.className='news-item';
      div.innerHTML = `<div style="font-weight:700">${item.title}</div><div style="font-size:12px;color:var(--muted)">${item.src} • ${item.time}</div><div style="margin-top:6px">${item.summary}</div>`;
      insightsEl.insertBefore(div, insightsEl.firstChild);
    }

    function runQuickScan(){
      const areaKey = document.getElementById('coverage-area').value;
      const area = regionData[areaKey];
      if(!area) return;
      // rank states by v * impact
      const ranked = area.states.map(s => ({...s, score: s.v * s.impact})).sort((a,b)=>b.score - a.score);
      appendChat('assistant', `Quick scan for ${areaKey}: Top priority ${ranked[0].n} (score ${Math.round(ranked[0].score)}). Suggestions injected to Insights panel.`);
      // add top to insights
      const top = ranked[0];
      const item = { title:`QuickScan: ${top.n} top risk`, src:'HiLabs AI', time:'now', summary:`${top.n} — overpay ${top.v}%, impact $${top.impact}M. Action: prioritize contract workstream.` };
      const div = document.createElement('div'); div.className='news-item';
      div.innerHTML = `<div style="font-weight:700">${item.title}</div><div style="font-size:12px;color:var(--muted)">${item.src} • ${item.time}</div><div style="margin-top:6px">${item.summary}</div>`;
      insightsEl.insertBefore(div, insightsEl.firstChild);
    }

    document.getElementById('run-scan').addEventListener('click', runQuickScan);

    /****************************************************************
     * Export & tooling
     ****************************************************************/
    document.getElementById('export-suggestions').addEventListener('click', ()=> {
      // Export recent chat as CSV
      const chats = Array.from(document.querySelectorAll('#chat-box .chat-row')).map(r => {
        const role = r.className.includes('chat-user') ? 'user' : 'assistant';
        const text = r.innerText.replace(/\n/g,' ');
        return `"${role}","${text.replace(/"/g,'""')}"`;
      });
      if(!chats.length){ alert('No chat to export'); return; }
      const csv = 'role,message\n' + chats.join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'chat_export.csv'; a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    document.getElementById('download-predictions').addEventListener('click', () => {
      // If a chart exists, try to pull prediction line points; else export last summary
      const summary = document.getElementById('predictor-summary').innerText || 'No predictions yet';
      const blob = new Blob([summary], {type:'text/plain;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'predictions.txt'; a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    /****************************************************************
     * Initial boot
     ****************************************************************/
    renderInsights();
    appendChat('assistant', 'Hello! I am HiLabs Assistant. Ask about region risk, specialties to target, or run forecasts. Toggle "Use LLM" to route queries to an external model.');
    runQuickScan();
  </script>
</body>
</html>
