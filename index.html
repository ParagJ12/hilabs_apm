<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>HiLabs — HiView Dashboard (Jenifer Hayes) — AI-enhanced</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root{
      --hi-blue:#2c6aef;
      --hi-bg:#f8f9fa;
      --panel-bg:#ffffff;
      --muted:#6b7280;
      --accent:#2c6aef;
    }
    html,body { height:100%; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; background:var(--hi-bg); margin:0; padding:0; color:#0b1220; }
    .container-fluid { padding:18px; max-width:1400px; margin:auto; }

    /* Header */
    .header { 
      padding: 14px 18px; background: var(--hi-blue); color: #fff; border-radius:10px; margin-bottom: 14px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      box-shadow:0 6px 18px rgba(44,106,239,0.12);
      position:relative; z-index:1000;
    }
    .header-left { display:flex; flex-direction:column; }
    .header h4{ margin:0; font-weight:700; font-size:20px; }
    .header-subtitle{ font-size:13px; color: rgba(255,255,255,0.95); margin-top:6px; }
    .kpi-group { display:flex; gap:10px; align-items:center; flex-wrap:nowrap; overflow-x:auto; padding-left:6px; }
    .kpi { background:var(--panel-bg); border-radius:8px; padding:10px 12px; min-width:150px; text-align:center; box-shadow:0 2px 6px rgba(2,6,23,0.06); border-left:4px solid var(--accent); flex:0 0 auto; }
    .tile-title { font-size:12px; color:var(--muted); font-weight:600; }
    .tile-value { font-weight:700; font-size:18px; margin-top:4px; color:#0b1220; }

    /* Panels */
    .panel { background:var(--panel-bg); padding:14px; border-radius:10px; box-shadow:0 4px 10px rgba(2,6,23,0.04); border-left:4px solid var(--accent); }
    .panel h6 { margin-top:0; font-weight:700; font-size:16px; border-bottom:2px solid var(--accent); padding-bottom:8px; margin-bottom:12px; }
    .small-muted{ color:var(--muted); font-size:13px; }

    /* Map container - position relative to contain absolute legend */
    .map-container {
      position: relative;
      height: 360px;
      border-radius: 8px;
      overflow: hidden;
    }
    #map { height: 100%; width: 100%; border-radius: 8px; border: 1px solid #e6edf8; position: relative; z-index: 1; }

    .map-legend { position: absolute; top: 10px; right: 10px; z-index: 1000; background: rgba(255,255,255,0.98); padding: 10px 12px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-left: 3px solid var(--accent); font-size: 12px; min-width: 180px; backdrop-filter: blur(4px); }
    .legend-title { font-weight:700; margin-bottom:8px; font-size:13px; color:#0b1220; }
    .legend-row { display:flex; gap:8px; align-items:center; margin-bottom:6px; }
    .legend-swatch { width:14px; height:14px; border-radius:3px; display:inline-block; border:1px solid rgba(0,0,0,0.12); }
    .legend-text { font-size:12px; color:#0b1220; }

    /* layout control */
    .panel-eq { min-height: 280px; display:flex; flex-direction:column; }

    /* tables */
    .scroll-table { max-height:210px; overflow:auto; padding-right:6px; }
    .table thead th { background:var(--accent); color:#fff; position:sticky; top:0; z-index:2; font-weight:700; font-size:12px; }
    .table-sm td { font-size:13px; color:#081827; }

    /* quality plot */
    #quality-plot { height:260px; width:100%; }

    /* scenario */
    .scenario-box { border-left:4px solid var(--accent); padding:16px; border-radius:10px; }
    .scenario-controls { min-width:260px; }
    .scenario-results { flex:1; max-height:240px; overflow:auto; padding-left:12px; }

    /* AI pane */
    .ai-pane { margin-top:12px; display:flex; flex-direction:column; gap:8px; }
    .ai-suggestion { border-left:4px solid #ef4444; padding:10px; border-radius:6px; background:#fff; box-shadow:0 2px 8px rgba(2,6,23,0.04); }
    .ai-actions { display:flex; gap:8px; }

    /* footer */
    .footer{ text-align:center; color:var(--muted); margin-top:14px; font-size:13px; }

    /* responsive tweaks */
    @media (max-width: 1100px){
      .header{ flex-direction:column; align-items:flex-start; gap:12px; }
      .kpi { min-width:120px; padding:8px; }
      .map-container { height:300px; }
      #quality-plot { height:220px; }
      .panel-eq { min-height:220px; }
      .map-legend { right:8px; top:8px; min-width:170px; font-size:11px; }
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <!-- header -->
    <div class="header">
      <div class="header-left">
        <h4>HiLabs | Risk & Rate Intelligence Platform</h4>
        <div class="header-subtitle">User: Jenifer Hayes — VP, Network Strategy</div>
      </div>

      <div class="kpi-group" aria-hidden="false">
        <div class="kpi"><div class="tile-title">Patient Satisfaction</div><div class="tile-value">81 / 100</div><div class="small-muted">Conf 82%</div></div>
        <div class="kpi"><div class="tile-title">Provider ROI</div><div class="tile-value">112.6%</div><div class="small-muted">Conf 88%</div></div>
        <div class="kpi"><div class="tile-title">Accessibility</div><div class="tile-value">58 / 100</div><div class="small-muted">Conf 75%</div></div>
        <!-- Removed one KPI to declutter as requested -->
      </div>
    </div>

    <!-- top row -->
    <div class="row g-3 align-items-start">
      <div class="col-lg-3">
        <div class="panel panel-eq">
          <h6>Network Snapshot</h6>
          <label class="small-muted" style="font-weight:700">Network Name</label>
          <select id="network-name" class="form-select form-select-sm mb-2">
            <option value="PacificCare Integrated Health">PacificCare Integrated Health Network</option>
            <option value="Midwest Regional Medical">Midwest Regional Medical Alliance</option>
            <option value="Tri-State Wellness">Tri-State Wellness Group</option>
            <option value="Northeast Community Health">Northeast Community Health Partners</option>
            <option value="Southern Cross Healthcare">Southern Cross Healthcare Network</option>
            <option value="Great Plains Care Connect">Great Plains Care Connect</option>
            <option value="Bayview Specialty Health" selected>Bayview Specialty Health System</option>
            <option value="Rocky Mountain Health">Rocky Mountain Health Collaborative</option>
          </select>

          <label class="small-muted" style="font-weight:700">Network Type</label>
          <select id="network-type" class="form-select form-select-sm mb-2">
            <option>Type-1: Primary Care Network</option>
            <option>Type-2: Specialty Care Network</option>
            <option selected>Type-3: Behavioral Health Network</option>
            <option>Type-4: Dental/Vision Network</option>
            <option>Type-5: Multi-Specialty Network</option>
            <option>Type-6: Accountable Care Organization (ACO)</option>
            <option>Type-7: Managed Care Network (HMO/PPO)</option>
          </select>

          <label class="small-muted" style="font-weight:700">Coverage Area</label>
          <select id="coverage-area" class="form-select form-select-sm mb-3">
            <option value="Southwest">Southwest Corridor – AZ, NM, NV</option>
            <option value="New England">New England Region – MA, CT, RI, NH</option>
            <option value="Pacific Northwest">Pacific Northwest – WA, OR, Northern CA</option>
            <option value="Great Lakes" selected>Great Lakes Region – IL, MI, OH</option>
            <option value="Southeast">Southeast Coastal – FL, GA, SC</option>
            <option value="Mountain States">Mountain States – CO, UT, ID</option>
          </select>

          <hr>
          <div><strong>Providers:</strong> <span id="provider-count">480</span></div>
          <div style="margin-top:8px"><strong>Savings Opp:</strong> <span id="savings-opp">9 contracts (~$7.4M)</span></div>
          <div style="margin-top:8px"><strong>Rate Score:</strong> <span id="rate-score">6.0 / 10</span></div>
          <div style="margin-top:8px"><strong>Adequacy:</strong> <span id="adequacy">93%</span></div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="panel">
          <h6>Key Metrics</h6>
          <div class="row">
            <div class="col-4">
              <div class="small-muted">Total Network Spend</div>
              <div style="font-weight:700; font-size:18px" id="total-spend">$150M</div>
              <div class="small-muted">Trend: Down 3% YoY</div>
            </div>
            <div class="col-4">
              <div class="small-muted">Cost Leakage</div>
              <div style="font-weight:700; font-size:18px" id="cost-leakage">$7.4M</div>
              <div class="small-muted">From rate benchmarking</div>
            </div>
            <div class="col-4">
              <div class="small-muted">Market Position</div>
              <div style="font-weight:700; font-size:18px" id="market-position">+3.6% above median</div>
              <div class="small-muted">Overpay +3.6%</div>
            </div>
          </div>
        </div>

        <div class="panel" style="padding:14px;">
          <!-- Map container with legend overlay -->
          <div class="map-container">
            <div id="map"></div>
            <!-- Legend positioned absolutely on top of map -->
            <div class="map-legend">
              <div class="legend-title">Heatmap: Intensity = Overpay × Impact</div>
              <div class="legend-row">
                <span class="legend-swatch" style="background:#ff4d4f"></span>
                <div class="legend-text">Hot: High overpay & high impact</div>
              </div>
              <div class="legend-row">
                <span class="legend-swatch" style="background:#ffb86b"></span>
                <div class="legend-text">Warm: Moderate risk</div>
              </div>
              <div class="legend-row">
                <span class="legend-swatch" style="background:#7dd3fc"></span>
                <div class="legend-text">Cool: Low impact / on-market</div>
              </div>
              <div style="margin-top:6px; font-size:11px; color:var(--muted)">Tip: click a marker to see contextual recommendations.</div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-3">
        <div class="panel panel-eq">
          <h6>Automated Insights</h6>

          <div id="ai-suggestions" class="ai-pane">
            <!-- suggestions will be injected here -->
          </div>

          <div style="margin-top:auto; font-size:13px; color:var(--muted);">
            <div style="margin-bottom:6px;">Quick actions:</div>
            <div class="ai-actions">
              <button id="export-suggestions" class="btn btn-sm btn-outline-primary">Export suggestions</button>
              <button id="run-scan" class="btn btn-sm btn-outline-success">Run quick scan</button>
            </div>
          </div>

          <hr/>
          <div>
            <label class="small-muted">Ask AI (quick)</label>
            <div class="input-group input-group-sm">
              <input id="ai-question" class="form-control" placeholder="e.g., Which specialty to target first?" />
              <button id="ai-ask" class="btn btn-primary">Ask</button>
            </div>
            <div id="ai-answer" style="margin-top:8px; font-size:13px; color:#0b1220"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- middle row -->
    <div class="row g-3 mt-2">
      <div class="col-md-4">
        <div class="panel panel-eq">
          <h6>Financial Strength <small class="small-muted">Score: 72/100</small></h6>
          <div class="scroll-table" id="financial-table"></div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="panel panel-eq">
          <h6>Rate Benchmarking <small class="small-muted">Score: 65/100</small></h6>
          <div class="scroll-table" id="rate-table"></div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="panel panel-eq">
          <h6>Provider Quality <small class="small-muted">Score: 87/100</small></h6>
          <div id="quality-plot"></div>
        </div>
      </div>
    </div>

    <!-- scenario & goals -->
    <div class="row g-3 mt-3">
      <div class="col-lg-9">
        <div class="scenario-box panel d-flex gap-3">
          <div class="scenario-controls">
            <div style="font-weight:700; margin-bottom:8px;">Scenario Planner — What if I cut rates?</div>
            <label class="small-muted">Specialty</label>
            <select id="scenario-specialty" class="form-select form-select-sm mb-2">
              <option>Cardiology</option>
              <option>Orthopedics</option>
              <option>Radiology</option>
              <option>Primary Care</option>
            </select>
            <label class="small-muted">Rate Change (%)</label>
            <input id="scenario-slider" type="range" min="-10" max="10" value="-6" class="form-range mb-1">
            <div style="color:var(--accent); font-weight:700;" id="slider-value">-6%</div>
          </div>

          <div class="scenario-results" id="scenario-result"></div>
        </div>
      </div>

      <div class="col-lg-3">
        <div class="panel panel-eq">
          <h6>Strategic Goals</h6>
          <div class="small-muted">Cost Reduction</div>
          <div style="font-weight:700; font-size:16px">$9.2M / $15M</div>
          <div class="progress mb-3" style="height:12px"><div class="progress-bar bg-primary" style="width:61%; background-color:var(--hi-blue)!important">61%</div></div>
          <div class="small-muted">CMS Adequacy</div>
          <div style="font-weight:700; font-size:16px">92%</div>
          <div class="progress mb-3" style="height:12px"><div class="progress-bar bg-primary" style="width:92%; background-color:var(--hi-blue)!important">92%</div></div>
        </div>
      </div>
    </div>

    <div class="footer">Prototype (synthetic data) — HiLabs 2025 • No PHI</div>
  </div>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/plotly.js-dist@2.24.0/plotly.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- heatmap plugin -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.heat/0.2.0/leaflet-heat.js"></script>

  <script>
    // --- region data --- (unchanged structure from your original file)
    const regionData = {
      "Southwest": { center:[34.5,-111.5], zoom:6, states:[
        {s:"AZ", n:"Arizona", v:9, pos:[34.2,-111.7], impact:85, save:2.1, adequacy:91},
        {s:"NM", n:"New Mexico", v:7, pos:[34.5,-106.0], impact:42, save:0.9, adequacy:89},
        {s:"NV", n:"Nevada", v:11, pos:[39.0,-116.0], impact:58, save:1.8, adequacy:86}
      ]},
      "New England": { center:[43.5,-71.5], zoom:7, states:[
        {s:"MA", n:"Massachusetts", v:8, pos:[42.4,-71.4], impact:95, save:2.4, adequacy:95},
        {s:"CT", n:"Connecticut", v:10, pos:[41.6,-72.7], impact:62, save:1.6, adequacy:92},
        {s:"RI", n:"Rhode Island", v:6, pos:[41.7,-71.5], impact:28, save:0.7, adequacy:90},
        {s:"NH", n:"New Hampshire", v:5, pos:[43.7,-71.5], impact:35, save:0.9, adequacy:94}
      ]},
      "Pacific Northwest": { center:[45.5,-122], zoom:6, states:[
        {s:"WA", n:"Washington", v:7, pos:[47.5,-120.5], impact:78, save:1.9, adequacy:88},
        {s:"OR", n:"Oregon", v:9, pos:[43.9,-120.6], impact:55, save:1.4, adequacy:91},
        {s:"CA", n:"Northern California", v:12, pos:[40.5,-122], impact:125, save:3.2, adequacy:83}
      ]},
      "Great Lakes": { center:[42,-85], zoom:6, states:[
        {s:"IL", n:"Illinois", v:10, pos:[40,-89], impact:105, save:2.8, adequacy:88},
        {s:"MI", n:"Michigan", v:8, pos:[44.3,-85.6], impact:72, save:1.8, adequacy:91},
        {s:"OH", n:"Ohio", v:9, pos:[40.4,-82.9], impact:88, save:2.2, adequacy:90}
      ]},
      "Southeast": { center:[30.5,-82], zoom:6, states:[
        {s:"FL", n:"Florida", v:11, pos:[28,-81.5], impact:145, save:3.8, adequacy:82},
        {s:"GA", n:"Georgia", v:8, pos:[32.7,-83.5], impact:82, save:2.0, adequacy:90},
        {s:"SC", n:"South Carolina", v:7, pos:[33.8,-81.2], impact:48, save:1.2, adequacy:92}
      ]},
      "Mountain States": { center:[40,-111.5], zoom:6, states:[
        {s:"CO", n:"Colorado", v:9, pos:[39,-105.5], impact:92, save:2.3, adequacy:89},
        {s:"UT", n:"Utah", v:6, pos:[39.3,-111.7], impact:45, save:1.1, adequacy:93},
        {s:"ID", n:"Idaho", v:5, pos:[44,-114.7], impact:32, save:0.8, adequacy:96}
      ]}
    };

    const networkMetrics = {
      "Great Plains Care Connect": {spend:280, leakage:15.2, pos:"+8.1%"},
      "PacificCare Integrated Health": {spend:420, leakage:22.4, pos:"+10.5%"},
      "Midwest Regional Medical": {spend:310, leakage:13.6, pos:"+5.8%"},
      "Tri-State Wellness": {spend:245, leakage:12.3, pos:"+6.2%"},
      "Northeast Community Health": {spend:360, leakage:18.0, pos:"+9.0%"},
      "Southern Cross Healthcare": {spend:200, leakage:9.8, pos:"+4.2%"},
      "Bayview Specialty Health": {spend:150, leakage:7.4, pos:"+3.6%"},
      "Rocky Mountain Health": {spend:95, leakage:4.5, pos:"+2.0%"}
    };

    // small helper for color scale used for markers
    function colorFor(v){ if(v>10) return '#ef4444'; if(v>5) return '#f59e0b'; return '#10b981'; }

    // initialize map
    const map = L.map('map', {zoomControl:true, scrollWheelZoom:false}).setView([42,-85],6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'© OpenStreetMap', maxZoom:19 }).addTo(map);

    // heat layer container (global so we can update/clear)
    let heatLayer = null;
    let markerLayer = L.layerGroup().addTo(map);

    function buildHeatPoints(states){
      // heat plugin expects [lat, lng, intensity]
      // intensity = normalized(overpay * impact)
      // We'll compute intensity and scale to 0..1
      const raw = states.map(s => ({lat:s.pos[0], lng:s.pos[1], score: s.v * s.impact}));
      const maxScore = Math.max(...raw.map(r=>r.score), 1);
      return raw.map(r => [r.lat, r.lng, Math.min(1, r.score / maxScore)]);
    }

    function updateMap(regionKey){
      markerLayer.clearLayers();
      if(heatLayer){ map.removeLayer(heatLayer); heatLayer = null; }

      const data = regionData[regionKey];
      if(!data) return;
      map.flyTo(data.center, data.zoom, {duration:0.8});

      // create heat points
      const heatPoints = buildHeatPoints(data.states);
      heatLayer = L.heatLayer(heatPoints, {radius: 40, blur: 30, maxZoom: 12, gradient:{0.2: 'blue', 0.5:'orange', 0.9:'red'}}).addTo(map);

      // keep small interactive markers on top for click & tooltip (lighter than before)
      data.states.forEach(st => {
        const marker = L.circleMarker(st.pos, { radius:8, fillColor: colorFor(st.v), fillOpacity:0.95, color:'#fff', weight:1 }).addTo(markerLayer);
        marker.bindTooltip(`<div style="font-weight:600">${st.n} (${st.s})</div>Overpay: ${st.v}%<br>Impact: $${st.impact}M<br>Savings: $${st.save}M<br>Adequacy: ${st.adequacy}%`);
        marker.on('click', ()=> {
          showContextualSuggestions(st, regionKey);
          // also scroll to rate table to keep behaviour
          document.getElementById('rate-table').scrollIntoView({behavior:'smooth'});
        });
      });
    }

    // initial map
    updateMap("Great Lakes");
    document.getElementById('coverage-area').addEventListener('change', e=> updateMap(e.target.value));

    // network selection updates key metrics
    document.getElementById('network-name').addEventListener('change', function(e){
      const key = e.target.value;
      const m = networkMetrics[key] || networkMetrics["Bayview Specialty Health"];
      document.getElementById('total-spend').innerText = `$${m.spend}M`;
      document.getElementById('cost-leakage').innerText = `$${m.leakage}M`;
      document.getElementById('market-position').innerText = m.pos + ' above median';
      document.getElementById('provider-count').innerText = Math.max(60, Math.round(m.spend * 3.2));
      document.getElementById('savings-opp').innerText = `${Math.max(5, Math.round(m.leakage/0.8))} contracts (~$${m.leakage.toFixed(1)}M)`;
      document.getElementById('rate-score').innerText = `${Math.max(5,(10 - Math.round(m.leakage/2))).toFixed(1)} / 10`;
      document.getElementById('adequacy').innerText = `${Math.max(85, 95 - Math.round(m.leakage/3))}%`;

      // refresh AI suggestions since network changed
      runQuickScan();
    });

    // render tables and plot (kept same but modular)
    const financialRows = [
      {m:"Net Network Revenue", v:"$3.123B", p:"99th", s:"Excellent"},
      {m:"Avg Provider Margins", v:"-5.1%", p:"31st", s:"Below Avg"},
      {m:"Net Operating Profit", v:"11.8%", p:"6th", s:"Poor"},
      {m:"Days Outstanding", v:"39.1", p:"72nd", s:"Average"},
      {m:"Network Savings Identified", v:"$12.3M", p:"68th", s:"Above Avg"}
    ];
    const rateRows = [
      {sp:"Cardiology (Office)", cur:420, med:390, pct:75, st:"OVERPAYING", sav:"$150K/provider"},
      {sp:"Orthopedics", cur:380, med:350, pct:80, st:"OVERPAYING", sav:"$120K/provider"},
      {sp:"Primary Care", cur:185, med:175, pct:60, st:"MODERATE", sav:"$95K/provider"},
      {sp:"Radiology (MRI)", cur:520, med:475, pct:82, st:"OVERPAYING", sav:"$180K"},
      {sp:"General Surgery", cur:680, med:620, pct:77, st:"OVERPAYING", sav:"$140K"}
    ];

    function renderFinancial(){
      const el = document.getElementById('financial-table');
      let html = '<table class="table table-sm"><thead><tr><th>Metric</th><th>Value</th><th>Percentile</th><th>Status</th></tr></thead><tbody>';
      financialRows.forEach(r => html += `<tr><td>${r.m}</td><td>${r.v}</td><td>${r.p}</td><td>${r.s}</td></tr>`);
      html += '</tbody></table>'; el.innerHTML = html;
    }
    function renderRateTable(){
      const el = document.getElementById('rate-table');
      let html = '<table class="table table-sm"><thead><tr><th>Specialty</th><th>Current</th><th>Median</th><th>Pctl</th><th>Status</th><th>Savings</th></tr></thead><tbody>';
      rateRows.forEach(r => html += `<tr><td>${r.sp}</td><td>$${r.cur}</td><td>$${r.med}</td><td>${r.pct}th</td><td>${r.st}</td><td>${r.sav}</td></tr>`);
      html += '</tbody></table>'; el.innerHTML = html;
    }
    function renderQuality(){
      const rows = [
        {x:90,y:15,label:"Ortho Surgery Center X"},
        {x:75,y:85,label:"North Cardiology Clinic"},
        {x:82,y:72,label:"Metro Radiology"},
        {x:60,y:78,label:"Community PCP Group"},
        {x:50,y:49,label:"Rural Health Center"}
      ];
      const data = [{ x: rows.map(r=>r.x), y: rows.map(r=>r.y), text: rows.map(r=>r.label), mode:'markers', marker:{ size:12, color: rows.map(r=> r.y>=80 ? '#2c6aef':'#f59e0b') } }];
      const layout = { margin:{t:8,l:40,r:8,b:30}, xaxis:{title:'Cost Percentile'}, yaxis:{title:'Quality Percentile'}, hovermode:'closest' };
      Plotly.newPlot('quality-plot', data, layout, {displayModeBar:false, responsive:true});
    }

    // Scenario logic (unchanged)
    const slider = document.getElementById('scenario-slider');
    const sliderValue = document.getElementById('slider-value');
    const scenarioResult = document.getElementById('scenario-result');

    function updateScenario(){
      const cut = Number(slider.value);
      sliderValue.innerText = (cut>0?'+':'') + cut + '%';
      const specialty = document.getElementById('scenario-specialty').value;
      const baseM = 150;
      const savings = Math.round(Math.abs(cut) * 1.3 * 100)/100;
      const exitRisk = Math.min(100, Math.round(Math.abs(cut)*3 + 2));
      const adequacyAfter = Math.max(78, 92 - Math.round(Math.max(0, (Math.abs(cut)-3)*1.5)));

      scenarioResult.innerHTML = `<div style="font-weight:700; margin-bottom:8px;">Specialty: ${specialty} &nbsp; Cut: ${cut}%</div>
        <table class="table table-sm mb-2"><thead><tr><th>Metric</th><th>Before</th><th>After</th></tr></thead>
        <tbody>
          <tr><td>Total Spend</td><td>$${baseM}M</td><td>$${(baseM - savings).toFixed(2)}M</td></tr>
          <tr><td>Projected Savings</td><td>—</td><td><strong>$${savings}M</strong></td></tr>
          <tr><td>Provider Exit Risk</td><td>—</td><td>${exitRisk}%</td></tr>
          <tr><td>Network Adequacy</td><td>92%</td><td>${adequacyAfter}%</td></tr>
        </tbody></table>
        <div class="alert alert-info mb-0"><strong>Recommendation:</strong> Consider smaller cut (e.g., 4%) or recruit providers to maintain adequacy.</div>`;
    }

    slider.addEventListener('input', updateScenario);
    document.getElementById('scenario-specialty').addEventListener('change', updateScenario);

    // -------- AI / Automation (rule-based suggestions) ------------
    const aiContainer = document.getElementById('ai-suggestions');

    function clearAISuggestions(){ aiContainer.innerHTML = ''; }

    function addSuggestion(title, body, confidence){
      const el = document.createElement('div');
      el.className = 'ai-suggestion';
      el.innerHTML = `<div style="font-weight:700; margin-bottom:6px">${title} <span style="float:right; font-weight:600; color:var(--muted); font-size:12px">${Math.round(confidence*100)}% conf</span></div>
                      <div style="font-size:13px; color:#0b1220">${body}</div>`;
      aiContainer.appendChild(el);
    }

    function showContextualSuggestions(stateObj, regionKey){
      clearAISuggestions();
      // Heuristic suggestions
      // 1. If overpay > 10 or adequacy < 88 and impact large -> high-priority
      const v = stateObj.v;
      const impact = stateObj.impact;
      const adequacy = stateObj.adequacy || 92;
      const region = regionKey;

      if(v > 10 && impact > 50){
        addSuggestion(`Negotiate top contracts in ${stateObj.n}`, `State shows ${v}% overpayment with $${impact}M impact. Run targeted RFPs for top 3 specialties and prioritize contract renegotiation with providers contributing highest spend. Consider temporary carve-outs to protect adequacy.`, 0.92);
      } else if(v > 8){
        addSuggestion(`Monitor & engage in ${stateObj.n}`, `Overpayment ${v}%. Start clinical & coding audit for top 5 billing facilities and prepare negotiation model. Consider mild rate reductions with provider incentives.`, 0.78);
      } else {
        addSuggestion(`Low immediate pricing risk`, `Overpayment ${v}%. Maintain monitoring cadence and focus on access/adequacy improvement if needed.`, 0.65);
      }

      if(adequacy < 90){
        addSuggestion(`Adequacy risk — recruit PCPs`, `Adequacy ${adequacy}% in ${stateObj.n}. Suggest shortlisting 2–4 high-value PCP practices for targeted contracting and offering onboarding incentives to close adequacy gap.`, 0.85);
      }

      // add operational suggestion (save / next steps)
      addSuggestion(`Next steps (automated)`, `1) Add ${stateObj.n} to "High Priority" watchlist. 2) Launch provider-level cost drilldown. 3) Prepare stakeholder memo summarizing expected savings and exit risk. Use the 'Export suggestions' button to download this as CSV.`, 0.76);
    }

    // Quick scan across currently selected coverage area to produce top 3 suggestions
    function runQuickScan(){
      clearAISuggestions();
      const areaKey = document.getElementById('coverage-area').value;
      const area = regionData[areaKey];
      if(!area){ addSuggestion('No data','No region selected or no data available.',0.35); return; }

      // heuristics: rank states by score = v * impact
      const ranked = area.states.map(s => ({...s, score: s.v * s.impact})).sort((a,b)=>b.score - a.score);
      const top = ranked.slice(0,3);

      addSuggestion(`Top priorities in ${areaKey}`, `Found ${area.states.length} states. Top priority: ${top[0].n} (score ${Math.round(top[0].score)}). See targeted actions below.`, 0.88);

      top.forEach((t, idx) => {
        const conf = Math.min(0.95, Math.max(0.6, t.score / 200));
        addSuggestion(`${idx+1}. ${t.n} — Actionable`, `Overpay ${t.v}% — impact $${t.impact}M. Recommended: negotiate cardiology & radiology contracts; run coding audit and prepare targeted RFP for high-volume providers.`, conf);
      });

      // specialty-level automated suggestion derived from rateTable
      const overpaySpecialties = rateRows.filter(r => r.st.includes('OVERPAYING')).map(r=>r.sp);
      if(overpaySpecialties.length){
        addSuggestion('Specialty play', `Automated pick: prioritize ${overpaySpecialties[0]} for initial RFP based on highest savings per provider (${rateRows[0].sav}).`, 0.81);
      }
    }

    // Export suggestions to CSV
    function exportSuggestionsCSV(){
      const items = Array.from(document.querySelectorAll('.ai-suggestion')).map(div => {
        const title = div.querySelector('div').innerText.replace(/\n/g,' ').trim();
        const body = div.querySelectorAll('div')[1].innerText.replace(/\n/g,' ').trim();
        return { title, body };
      });
      if(!items.length){ alert('No suggestions to export'); return; }
      const header = 'title,body\n';
      const rows = items.map(i => `"${i.title.replace(/"/g,'""')}","${i.body.replace(/"/g,'""')}"`).join('\n');
      const csv = header + rows;
      const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'hiview_suggestions.csv'; document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    // Simple "Ask AI" handler: uses local context to answer some templated questions
    function askAIQuestion(q){
      const ql = q.toLowerCase();
      const areaKey = document.getElementById('coverage-area').value;
      const area = regionData[areaKey];
      if(ql.includes('which specialty') || ql.includes('specialty to target')){
        const overpay = rateRows.filter(r=>r.st.includes('OVERPAYING')).slice(0,1).map(r=>r.sp).join(', ');
        return `Based on current benchmarking, start with ${overpay}. Recommendation: run targeted RFP for that specialty and prioritize providers with highest volume. Confidence: 78%`;
      }
      if(ql.includes('what is the biggest risk') || ql.includes('biggest risk')){
        // compute biggest by heat score in area
        const ranked = area.states.map(s => ({...s, score: s.v * s.impact})).sort((a,b)=>b.score - a.score);
        const top = ranked[0];
        return `Biggest regional risk: ${top.n} — ${top.v}% overpay and $${top.impact}M impact. Action: prioritize contract negotiation and adequacy protections. Confidence: 88%`;
      }
      if(ql.includes('how to reduce leakage') || ql.includes('leakage')){
        return `Start with: 1) specialty-targeted RFPs, 2) coding audits in top overpay states, 3) selective rate reductions with quality incentives. Consider a pilot in 1 state first. Confidence: 80%`;
      }
      return `I can provide automated recommendations like "top states to target", "specialties to RFP", or "adequacy actions". Try asking "Which specialty to target first?" or "What's the biggest risk in the region?"`;
    }

    // Wire up buttons
    document.getElementById('run-scan').addEventListener('click', runQuickScan);
    document.getElementById('export-suggestions').addEventListener('click', exportSuggestionsCSV);
    document.getElementById('ai-ask').addEventListener('click', ()=> {
      const q = document.getElementById('ai-question').value || '';
      if(!q){ document.getElementById('ai-answer').innerText = 'Please type a question.'; return; }
      document.getElementById('ai-answer').innerText = 'Thinking…';
      // lightweight simulated latency
      setTimeout(()=> {
        document.getElementById('ai-answer').innerText = askAIQuestion(q);
      }, 300);
    });

    // initial quick scan and suggestion fill
    renderFinancial(); renderRateTable(); renderQuality(); updateScenario();
    runQuickScan();

    // keep suggestions updated when coverage area changes (so map + suggestions match)
    document.getElementById('coverage-area').addEventListener('change', () => {
      runQuickScan();
    });

    // Also refresh suggestions when user interacts with scenario slider to produce AI-backed suggestion
    slider.addEventListener('change', ()=> {
      const cut = Number(slider.value); const specialty = document.getElementById('scenario-specialty').value;
      clearAISuggestions();
      addSuggestion(`Scenario analysis — ${specialty}`, `You simulated a ${cut}% change. Automated note: if cut > 5% expect exit risk > 15% for that specialty. Consider pairing cuts with performance-based incentives.`, 0.72);
    });
  </script>
</body>
</html>
